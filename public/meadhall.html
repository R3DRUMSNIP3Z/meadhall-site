<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mead Hall • Global Chat</title>

  <!-- Match profile/account pages so API refresh works -->
  <meta name="api-base" content="http://localhost:5050" />

  <style>
    body {
      background:#0b0e10;
      color:#e9e4d5;
      font-family: "Cinzel", serif;
      display:flex;
      flex-direction:column;
      height:100vh;
      margin:0;
    }
    /* Global header */
    header.site-header {
      position:relative;
      z-index:50;
      background:#151515d0;
      border-bottom:1px solid #3b3325;
    }
    header.site-header .wrap {
      display:flex; align-items:center; gap:16px;
      padding:.6rem 1rem;
    }
    header.site-header h1 { font-size:1.1rem; margin:0; }
    nav a {
      color:#e9e4d5; text-decoration:none; font-size:.9rem;
    }
    nav { margin-left:auto; display:flex; gap:16px; }
    nav a:hover { color:#ffd700; }

    /* Chat title */
    .chat-title {
      padding:1rem;
      text-align:center;
      font-size:1.7rem;
      font-weight:bold;
      border-bottom:2px solid #3b3325;
      color:#ffd700;
      text-shadow: 0 0 5px #d4a94d, 0 0 10px #ffcc00, 0 0 15px #ffea80;
    }

    #chatBox {
      flex:1;
      overflow-y:auto;
      padding:1rem;
    }
    .msg {
      display:flex;
      align-items:flex-start;
      margin-bottom:1rem;
    }
    .msg img.avatar {
      width:40px; height:40px;
      border-radius:50%;
      margin-right:.5rem;
      cursor:pointer;
      object-fit:cover;
      border:1px solid #3b3325;
      background:#222;
    }
    .bubble {
      background:#151515d0;
      padding:.5rem 1rem;
      border-radius:12px;
      max-width:60%;
      word-wrap:break-word;
    }
    .meta {
      font-weight:700;font-size:.9rem;margin-bottom:.2rem
    }
    #chatInputRow {
      display:flex;
      padding:.5rem;
      background:#151515d0;
      border-top:2px solid #3b3325;
      gap:.5rem;
    }
    #chatInput {
      flex:1;
      padding:.5rem;
      border:none;
      border-radius:6px;
    }
    #sendBtn, #emojiGifBtn {
      padding:.5rem 1rem;
      border:none;
      border-radius:6px;
      cursor:pointer;
      background:#d4a94d;
      color:#0b0e10;
      font-weight:bold;
    }
    #emojiGifPicker {
      position:absolute;
      bottom:60px;
      left:10px;
      background:#151515;
      padding:10px;
      border:1px solid #3b3325;
      border-radius:8px;
      display:none;
      max-height:300px;
      overflow:auto;
      width:340px;
      z-index:100;
    }
    #emojiGifPicker .gif-grid img {
      margin:5px;
      cursor:pointer;
      border-radius:6px;
      max-height:60px;
    }
    .sys {
      text-align:center; opacity:.7; font-size:.9rem; margin:.4rem 0;
    }
  </style>
</head>
<body>
  <!-- Global header -->
  <header class="site-header">
    <div class="wrap">
      <a href="/" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit">
        <img src="/logo/logo-64.png" alt="Mead Hall" style="width:32px;height:32px;border-radius:6px;object-fit:cover"/>
        <h1>Mead Hall</h1>
      </a>
      <nav>
        <a href="/index.html#plans">Membership</a>
        <a href="/index thumb.html#contest">Skald Contest</a>
        <a href="/index.html#lore">Lore</a>
        <a href="/account.html">Account</a>
      </nav>
    </div>
  </header>

  <!-- Chat Title -->
  <div class="chat-title">⚔️ Mead Hall • Global Chat ⚔️</div>

  <div id="chatBox"></div>

  <!-- Combined Emoji + GIF picker -->
  <div id="emojiGifPicker">
    <div id="emojiContainer"></div>
    <hr style="border-color:#3b3325;">
    <input id="gifSearch" type="text" placeholder="Search GIFs..." style="width:100%;margin-bottom:5px;"/>
    <div class="gif-grid"></div>
  </div>

  <div id="chatInputRow">
    <input id="chatInput" type="text" placeholder="Type your message..." />
    <button id="emojiGifBtn">😀 GIF</button>
    <button id="sendBtn">Send</button>
  </div>

  <!-- Uses /src/chatGlobal.ts helper (history + SSE + send) -->
  <script type="module">
    import {
      getGlobalHistory,
      openGlobalStream,
      sendGlobalMessage,
      startGlobalPolling
    } from "/src/chatGlobal.ts";

    const LS_KEY_MAIN = 'mh_user';
    const LS_KEY_FALLBACK = 'user';
    const DEFAULT_AVATAR = "/logo/logo-512.png";

    function getUser() {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY_MAIN) || localStorage.getItem(LS_KEY_FALLBACK) || 'null');
      } catch { return null; }
    }

    const chatBox = document.getElementById("chatBox");
    const input   = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    function parseMessage(text) {
      return String(text).replace(
        /(https?:[^\s]+\.(?:png|jpg|jpeg|gif|webp))/gi,
        '<img src="$1" style="max-width:220px;display:block;margin-top:6px;border-radius:8px;border:1px solid #3b3325;"/>'
      );
    }

    function renderMsg(msg) {
      const u = msg.user || {};
      const displayName = u.name || "skald";
      const avatarUrl = u.avatarUrl || DEFAULT_AVATAR;
      const profileLink = u.id ? `/profile/${u.id}` : "/account.html";

      const row = document.createElement("div");
      row.className = "msg";
      row.innerHTML = `
        <img class="avatar" src="${avatarUrl}" alt="${displayName}" onclick="window.location='${profileLink}'"/>
        <div class="bubble">
          <div class="meta">${displayName}</div>
          ${parseMessage(msg.text || "")}
        </div>
      `;
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function renderSystem(text) {
      const p = document.createElement('div');
      p.className = 'sys';
      p.textContent = text;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    let CURRENT_USER = getUser();
    let lastId = "";

    async function boot() {
      // 1) Initial history
      try {
        const list = await getGlobalHistory(lastId);
        for (const m of list) {
          renderMsg(m);
          if (m.id) lastId = m.id;
        }
      } catch {
        renderSystem("⚠️ Could not load history.");
      }

      // 2) Live stream with polling fallback
      if ("EventSource" in window) {
        openGlobalStream(
          (m) => { renderMsg(m); if (m.id) lastId = m.id; },
          () => renderSystem("Connected to the mead fire."),
          () => renderSystem("⚠️ Stream error — trying to keep going…")
        );
      } else {
        const ref = { current: lastId };
        startGlobalPolling(ref, (batch) => {
          batch.forEach((m) => { renderMsg(m); ref.current = m.id || ref.current; });
        });
        renderSystem("⚠️ No EventSource — using polling.");
      }

      // 3) Send (no optimistic render — SSE will render once)
      sendBtn.onclick = async () => {
        const text = input.value.trim();
        if (!text) return;
        sendBtn.disabled = true;
        try {
          await sendGlobalMessage(CURRENT_USER?.id ?? null, text);
          input.value = "";
        } catch {
          renderSystem("⚠️ Message failed to send.");
        } finally {
          sendBtn.disabled = false;
          input.focus();
        }
      };

      // Optional: Enter to send
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });
    }

    boot();

    /* ---------- Emoji + GIF picker (unchanged) ---------- */
    import "https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";
    const emojiPicker = document.createElement("emoji-picker");
    emojiPicker.style.maxHeight = "150px";
    emojiPicker.addEventListener("emoji-click", e => {
      input.value += e.detail.unicode;
      input.focus();
    });
    document.getElementById("emojiContainer").appendChild(emojiPicker);

    const gifGrid = document.querySelector("#emojiGifPicker .gif-grid");
    async function fetchGifs(query="funny"){
      const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=dc6zaTOxFJmzC&q=${encodeURIComponent(query)}&limit=8`);
      const data = await res.json();
      gifGrid.innerHTML = "";
      (data.data||[]).forEach(g=>{
        const img=document.createElement("img");
        img.src=g.images.fixed_height_small.url;
        img.alt=g.title||"gif";
        img.onclick=()=>{ input.value+=" "+g.images.original.url; document.getElementById("emojiGifPicker").style.display="none"; input.focus(); };
        gifGrid.appendChild(img);
      });
    }
    document.getElementById("gifSearch").addEventListener("keyup", e=>{
      if(e.key==="Enter") fetchGifs(e.target.value);
    });
    document.getElementById("emojiGifBtn").onclick = () => {
      const picker = document.getElementById("emojiGifPicker");
      picker.style.display = picker.style.display==="none"?"block":"none";
      if(picker.style.display==="block") fetchGifs();
    };
  </script>
</body>
</html>








































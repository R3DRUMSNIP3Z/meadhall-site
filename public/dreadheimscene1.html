```html
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Veriador • Dreadheim • Scene 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #000;
  font-family: Cinzel, serif;
  overflow: hidden;
}

/* Background */
#bg {
  position: fixed;
  inset: 0;
  background: url("/guildbook/scenes/dreadheim_scene1.png") center center / cover no-repeat;
  z-index: 0;
}

/* Dialogue UI */
#dlg {
  position: fixed;
  left: 50%;
  bottom: 14px;
  transform: translateX(-50%);
  width: min(1200px, calc(100vw - 24px));
  height: 190px;
  z-index: 10;
  display: grid;
  grid-template-columns: 240px 1fr;
  border-radius: 18px;
  overflow: hidden;
  background: linear-gradient(90deg, rgba(35,20,10,.95), rgba(15,10,8,.88));
  border: 1px solid rgba(255,208,120,.2);
  box-shadow: 0 18px 55px rgba(0,0,0,.6);
}

.hidden { display: none; }

#dlgPortrait {
  width: 240px;
  height: 190px;
  object-fit: contain;
  align-self: end;
  display: block;

  /* Optional subtle “alive” motion */
  opacity: 0;
  transform: translateY(6px) scale(0.98);
  animation:
    portraitIn 0.6s ease forwards,
    idleBreath 4s ease-in-out infinite,
    divineGlow 3.5s ease-in-out infinite;
  filter: drop-shadow(0 12px 22px rgba(0,0,0,0.65));
}

@keyframes portraitIn { to { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes idleBreath {
  0%, 100% { transform: translateY(0) scale(1); }
  50%      { transform: translateY(-2px) scale(1.01); }
}
@keyframes divineGlow {
  0%, 100% { filter: drop-shadow(0 12px 22px rgba(0,0,0,0.6)); }
  50%      { filter: drop-shadow(0 12px 30px rgba(180,200,255,0.65)); }
}

#dlgPanel {
  padding: 16px 18px;
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 10px;
}

#dlgName {
  font-size: 28px;
  font-weight: 900;
  color: rgba(255,225,170,.95);
}

#dlgText {
  font-size: 20px;
  line-height: 1.35;
  color: rgba(255,255,255,.95);
}

#dlgBtns {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.dlgBtn {
  padding: 10px 16px;
  border-radius: 12px;
  cursor: pointer;
  border: 1px solid rgba(255,208,120,.28);
  background: rgba(120,60,25,.45);
  color: rgba(255,245,230,.95);
  font-weight: 800;
}

.dlgBtn:hover { filter: brightness(1.1); }

.nameInput {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,208,120,.28);
  background: rgba(0,0,0,.3);
  color: #fff;
  font-size: 18px;
  margin-top: 10px;
}

/* Quest Icon (top-right) */
#questBtn {
  position: fixed;
  top: 14px;
  right: 14px;
  width: 52px;
  height: 52px;
  border: none;
  background: transparent;
  padding: 0;
  z-index: 50;
  cursor: pointer;
  display: none; /* shown when quest is active */
}

#questBtn img {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 10px 22px rgba(0,0,0,0.75));
  opacity: 0.95;
  transition: transform 120ms ease;
}

#questBtn:hover img { transform: scale(1.05); }

/* Quest Journal Overlay */
#questOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  z-index: 60;
  display: none;
}

#questPanel {
  position: absolute;
  top: 70px;
  right: 18px;
  width: min(520px, calc(100vw - 36px));
  max-height: calc(100vh - 110px);
  overflow: auto;
  background: rgba(0, 0, 0, 0.92);
  border: 1px solid rgba(255,255,255,0.14);
  border-radius: 16px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.7);
  padding: 14px 14px 16px;
}

/* Quest text colors (fix black text) */
#questPanel,
#questPanel * {
  color: rgba(245, 240, 230, 0.95);
}

/* Make the header/title warm and readable */
.qTitle {
  color: rgba(255, 215, 140, 0.98);
  font-weight: 800;
}

/* Quest content title (first line in the panel) */
#questContent > div:first-child {
  color: rgba(255, 215, 140, 0.98);
  font-weight: 900;
}

/* Lists/objectives */
#questPanel ol,
#questPanel li {
  color: rgba(240, 235, 225, 0.95);
}

/* Labels like Reward: */
#questPanel strong {
  color: rgba(255, 210, 160, 0.95);
}

/* Optional: subtle readability */
#questPanel {
  text-shadow: 0 1px 2px rgba(0,0,0,0.6);
}
#questClose {
  color: rgba(255, 215, 140, 1);
  font-size: 20px;
  font-weight: 900;
  background: rgba(0, 0, 0, 0.35);
  border: 1px solid rgba(255, 215, 140, 0.6);
}

#questClose:hover {
  background: rgba(255, 215, 140, 0.25);
  color: rgba(0, 0, 0, 0.9);
}


</style>
</head>

<body>
<div id="bg"></div>

<!-- Dialogue UI -->
<div id="dlg" class="hidden">
  <img id="dlgPortrait" alt="Portrait">
  <div id="dlgPanel">
    <div id="dlgName"></div>
    <div id="dlgText"></div>
    <div id="dlgBtns"></div>
  </div>
</div>

<!-- Quest Icon Button -->
<button id="questBtn" aria-label="Quest Journal" title="Quest Journal">
  <img src="/guildbook/ui/quest_icon.png" alt="">
</button>

<!-- Quest Journal Overlay -->
<div id="questOverlay" aria-hidden="true">
  <div id="questPanel">
    <div class="qHeader">
      <div class="qTitle">Quest</div>
      <button id="questClose" aria-label="Close">✕</button>
    </div>
    <div id="questContent"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  // ---------- Shared keys ----------
  const NAME_KEY  = "va_player_name";
  const ALIGN_KEY = "va_alignment";

  // ---------- Quest keys ----------
  const VAQ_ACTIVE_ID_KEY = "vaq_activeQuestId";
  const VAQ_CATALOG_KEY   = "vaq_activeQuestCatalog";

  // ---------- Dreadheim Scene save keys ----------
  const SCENE_ID   = "dreadheim_scene1";
  const SC_IDX_KEY = "va_dh1_idx";
  const SC_DONE    = "va_dh1_done";

  // JSON file for this scene
  const SCENE_JSON = "/data/episodes/volume1_ep1/dreadheim_scene1.json";

  // Defaults (can be overridden by JSON meta)
  const DEFAULT_BG = "/guildbook/scenes/dreadheim_scene1.png";
  const DEFAULT_SPEAKER = "Loki";
  const DEFAULT_PORTRAIT = "/guildbook/npcs/loki.gif";

  // Optional guard: only dreadheim
  const align = localStorage.getItem(ALIGN_KEY) || "";
  if (align && align !== "dreadheim") {
    window.location.href = "/myriadorscene1.html";
    return;
  }

  const bg = document.getElementById("bg");
  const dlg = document.getElementById("dlg");
  const dlgName = document.getElementById("dlgName");
  const dlgText = document.getElementById("dlgText");
  const dlgBtns = document.getElementById("dlgBtns");
  const dlgPortrait = document.getElementById("dlgPortrait");

  let playerName = localStorage.getItem(NAME_KEY) || "Traveler";

  function showDialogue({ name, text, buttons = [], portraitSrc }) {
    dlgName.textContent = name || DEFAULT_SPEAKER;
    dlgText.innerHTML = "";
    dlgBtns.innerHTML = "";
    dlg.classList.remove("hidden");

    dlgPortrait.src = portraitSrc || DEFAULT_PORTRAIT;
    dlgPortrait.style.display = "block";

    if (typeof text === "string") dlgText.textContent = text;
    else dlgText.appendChild(text);

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = "dlgBtn";
      btn.textContent = b.label;
      btn.onclick = b.onClick;
      dlgBtns.appendChild(btn);
    });
  }

  function hideDialogue() {
    dlg.classList.add("hidden");
  }

  async function loadJSON(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load " + url + " (" + res.status + ")");
    return await res.json();
  }

  function getInt(key, fallback = 0) {
    const v = parseInt(localStorage.getItem(key) || "", 10);
    return Number.isFinite(v) ? v : fallback;
  }

  function setInt(key, value) {
    localStorage.setItem(key, String(value));
  }

  function saveProgress(idx) {
    localStorage.setItem("va_save_active", "1");
    localStorage.setItem("va_episode", "volume1_ep1");
    localStorage.setItem("va_screen", SCENE_ID);
    setInt(SC_IDX_KEY, idx);
  }

  function gotoScreen(screenKey) {
    // Map logical screens to html pages
    const map = {
      "dreadheim_scene1_after": "/dreadheim_scene1_after.html",
      "dreadheim_meadhall": "/dreadheim_meadhall.html",
      "dreadheim_frostwood": "/dreadheim_frostwood.html"
    };
    window.location.href = map[screenKey] || "/dreadheimscene2.html";
  }

  // ===============================
  // QUEST SYSTEM (top-right icon + journal)
  // ===============================
  function setActiveQuest(questId, catalogUrl) {
    if (questId) localStorage.setItem(VAQ_ACTIVE_ID_KEY, questId);
    if (catalogUrl) localStorage.setItem(VAQ_CATALOG_KEY, catalogUrl);
    updateQuestIconVisibility();
  }

  function getActiveQuestId() {
    return localStorage.getItem(VAQ_ACTIVE_ID_KEY) || "";
  }

  function getActiveQuestCatalogUrl() {
  return (
    localStorage.getItem(VAQ_CATALOG_KEY) ||
    data?.onComplete?.questCatalog ||
    "/guildbook/quests/dreadheim_quests.json"
  );
}


  function updateQuestIconVisibility() {
    const btn = document.getElementById("questBtn");
    if (!btn) return;
    btn.style.display = getActiveQuestId() ? "block" : "none";
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function renderQuestJournal() {
    const content = document.getElementById("questContent");
    if (!content) return;

    const activeId = getActiveQuestId();
    const catalogUrl = getActiveQuestCatalogUrl();

    if (!activeId) {
      content.innerHTML = `<div style="opacity:.85">No active quest.</div>`;
      return;
    }
    if (!catalogUrl) {
      content.innerHTML = `<div style="opacity:.85">Quest catalog missing.</div>`;
      return;
    }

    const catalog = await loadJSON(catalogUrl);
    const q = catalog?.quests?.[activeId];

    if (!q) {
      content.innerHTML = `<div style="opacity:.85">Quest not found: ${escapeHtml(activeId)}</div>`;
      return;
    }

    const steps = (q.steps || []).map(s => `<li>${escapeHtml(s)}</li>`).join("");

    content.innerHTML = `
      <div style="font-size:18px; margin: 4px 0 10px; letter-spacing:.02em;">${escapeHtml(q.title)}</div>
      <div style="opacity:.9; margin-bottom:10px;">Giver: ${escapeHtml(q.giver || "Unknown")}</div>
      <div style="opacity:.9; margin-bottom:12px;">${escapeHtml(q.summary || "")}</div>
      <div style="margin: 10px 0 6px; opacity:.95;">Objectives</div>
      <ol style="margin:0 0 12px 18px; padding:0; opacity:.92;">
        ${steps}
      </ol>
      ${q.reward ? `<div style="opacity:.95;"><strong>Reward:</strong> ${escapeHtml(q.reward)}</div>` : ""}
    `;
  }

  function openQuestJournal() {
    const overlay = document.getElementById("questOverlay");
    if (!overlay) return;
    overlay.style.display = "block";
    overlay.setAttribute("aria-hidden", "false");
    renderQuestJournal();
  }

  function closeQuestJournal() {
    const overlay = document.getElementById("questOverlay");
    if (!overlay) return;
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
  }

  function bindQuestUI() {
    const btn = document.getElementById("questBtn");
    const close = document.getElementById("questClose");
    const overlay = document.getElementById("questOverlay");

    btn?.addEventListener("click", openQuestJournal);
    close?.addEventListener("click", closeQuestJournal);

    overlay?.addEventListener("click", (e) => {
      if (e.target === overlay) closeQuestJournal();
    });

    updateQuestIconVisibility();
  }

  // ✅ Bind quest UI ONCE (after the function exists)
  bindQuestUI();

  // Load scene data
  const data = await loadJSON(SCENE_JSON);

  // Apply meta (bg/portrait) if provided
  const metaBg = data?.meta?.bg;
  const metaPortrait = data?.meta?.portrait;
  const metaSpeakerDefault = data?.meta?.speakerDefault;

  const ACTIVE_BG = metaBg || DEFAULT_BG;
  const ACTIVE_PORTRAIT = metaPortrait || DEFAULT_PORTRAIT;
  const DEFAULT_NAME = metaSpeakerDefault || DEFAULT_SPEAKER;

  bg.style.background = `url("${ACTIVE_BG}") center center / cover no-repeat`;

  // -------- If already finished --------
  if (localStorage.getItem(SC_DONE) === "1") {
    updateQuestIconVisibility();
    showDialogue({
      name: DEFAULT_NAME,
      portraitSrc: ACTIVE_PORTRAIT,
      text: "Your mission remains.",
      buttons: [{
        label: "Continue",
        onClick: () => {
          hideDialogue();
          if (data.onComplete?.nextScreen) gotoScreen(data.onComplete.nextScreen);
          else window.location.href = "/dreadheimscene2.html";
        }
      }]
    });
    return;
  }

  // -------- Optional: ask name if missing --------
  if (!localStorage.getItem(NAME_KEY)) {
    await new Promise(resolve => {
      const input = document.createElement("input");
      input.className = "nameInput";
      input.placeholder = "Your name";
      input.maxLength = 18;

      const promptNode = (data.nodes || []).find(n => n.id === "name_prompt");
      const promptText = promptNode?.text || "Speak your name.";

      showDialogue({
        name: promptNode?.speaker || DEFAULT_NAME,
        portraitSrc: ACTIVE_PORTRAIT,
        text: promptText,
        buttons: [{
          label: "Continue",
          onClick: () => {
            playerName = (input.value || "").trim() || "Traveler";
            localStorage.setItem(NAME_KEY, playerName);
            hideDialogue();
            resolve();
          }
        }]
      });

      dlgText.appendChild(input);
      setTimeout(() => input.focus(), 50);
    });
  } else {
    playerName = localStorage.getItem(NAME_KEY) || playerName;
  }

  // -------- Run cutscene nodes (no quiz) --------
  let idx = getInt(SC_IDX_KEY, 0);
  saveProgress(idx);

  const nodes = Array.isArray(data.nodes) ? data.nodes : [];

  while (idx < nodes.length) {
    const n = nodes[idx];

    // Skip name prompt node if name already set (we handled above)
    if (n.id === "name_prompt" && localStorage.getItem(NAME_KEY)) {
      idx += 1;
      setInt(SC_IDX_KEY, idx);
      saveProgress(idx);
      continue;
    }

    await new Promise(resolve => {
      showDialogue({
        name: n.speaker || DEFAULT_NAME,
        portraitSrc: ACTIVE_PORTRAIT,
        text: (n.text || "").replace("{name}", playerName),
        buttons: [{
          label: "Continue",
          onClick: () => {
            hideDialogue();
            resolve();
          }
        }]
      });
    });

    idx += 1;
    setInt(SC_IDX_KEY, idx);
    saveProgress(idx);
  }

  // Mark done
  localStorage.setItem(SC_DONE, "1");

  // Apply onComplete (quest + icon + next screen)
  if (data.onComplete?.setQuestActive) {
    setActiveQuest(data.onComplete.setQuestActive, data.onComplete.questCatalog);
  }

  showDialogue({
    name: DEFAULT_NAME,
    portraitSrc: ACTIVE_PORTRAIT,
    text: "A mission has been placed upon you.",
    buttons: [{
      label: "Continue",
      onClick: () => {
        hideDialogue();
        if (data.onComplete?.nextScreen) gotoScreen(data.onComplete.nextScreen);
        else window.location.href = "/dreadheimscene2.html";
      }
    }]
  });

  // ===============================
  // DEV TOOLS (F12)
  // ===============================
  window.VA_DEV = window.VA_DEV || {};

  // Reset ONLY this Dreadheim scene
  window.VA_DEV.resetDreadheimScene1 = () => {
    console.warn("DEV: Resetting Dreadheim Scene 1");
    [SC_IDX_KEY, SC_DONE, "va_screen"].forEach(k => localStorage.removeItem(k));
    location.reload();
  };

  // Full episode reset (same as episode1.html)
  window.VA_DEV.resetEpisode1 = () => {
    console.warn("DEV: Resetting Episode I");
    [
      "va_player_name",
      "va_alignment",
      "va_episode",
      "va_screen",
      "va_save_active",
      "va_oath_idx",
      "va_oath_good",
      "va_oath_evil",
      "va_oath_done",
      SC_IDX_KEY,
      SC_DONE,
      VAQ_ACTIVE_ID_KEY,
      VAQ_CATALOG_KEY
    ].forEach(k => localStorage.removeItem(k));
    location.reload();
  };

});
</script>

</body>
</html>
```




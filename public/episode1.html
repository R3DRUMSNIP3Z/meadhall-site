<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Veriador • Episode I</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #000;
  font-family: Cinzel, serif;
  overflow: hidden;
}

/* Background */
#bg {
  position: fixed;
  inset: 0;
  background: url("/bggameimage.png") center center / cover no-repeat;
  z-index: 0;
}

/* Dialogue UI */
#dlg {
  position: fixed;
  left: 50%;
  bottom: 14px;
  transform: translateX(-50%);
  width: min(1200px, calc(100vw - 24px));
  height: 190px;
  z-index: 10;
  display: grid;
  grid-template-columns: 240px 1fr;
  border-radius: 18px;
  overflow: hidden;
  background: linear-gradient(90deg, rgba(35,20,10,.95), rgba(15,10,8,.88));
  border: 1px solid rgba(255,208,120,.2);
  box-shadow: 0 18px 55px rgba(0,0,0,.6);
}

.hidden { display: none; }

#dlgPortrait {
  width: 240px;
  height: 190px;
  object-fit: contain;
  align-self: end;
  display: block;
}

/* Optional subtle “alive” motion even for PNG */
#dlgPortrait {
  opacity: 0;
  transform: translateY(6px) scale(0.98);
  animation:
    portraitIn 0.6s ease forwards,
    idleBreath 4s ease-in-out infinite,
    divineGlow 3.5s ease-in-out infinite;
  filter: drop-shadow(0 12px 22px rgba(0,0,0,0.65));
}

@keyframes portraitIn {
  to { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes idleBreath {
  0%, 100% { transform: translateY(0) scale(1); }
  50%      { transform: translateY(-2px) scale(1.01); }
}
@keyframes divineGlow {
  0%, 100% { filter: drop-shadow(0 12px 22px rgba(0,0,0,0.6)); }
  50%      { filter: drop-shadow(0 12px 30px rgba(180,200,255,0.65)); }
}

#dlgPanel {
  padding: 16px 18px;
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 10px;
}

#dlgName {
  font-size: 28px;
  font-weight: 900;
  color: rgba(255,225,170,.95);
}

#dlgText {
  font-size: 20px;
  line-height: 1.35;
  color: rgba(255,255,255,.95);
}

#dlgBtns {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.dlgBtn {
  padding: 10px 16px;
  border-radius: 12px;
  cursor: pointer;
  border: 1px solid rgba(255,208,120,.28);
  background: rgba(120,60,25,.45);
  color: rgba(255,245,230,.95);
  font-weight: 800;
}

.dlgBtn:hover { filter: brightness(1.1); }

.nameInput {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,208,120,.28);
  background: rgba(0,0,0,.3);
  color: #fff;
  font-size: 18px;
}
</style>
</head>

<body>
<div id="bg"></div>

<!-- Dialogue UI -->
<div id="dlg" class="hidden">
  <img id="dlgPortrait" alt="Frigga">
  <div id="dlgPanel">
    <div id="dlgName"></div>
    <div id="dlgText"></div>
    <div id="dlgBtns"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const NAME_KEY = "va_player_name";
  const ALIGN_KEY = "va_alignment";
  const OATH_IDX  = "va_oath_idx";
  const OATH_GOOD = "va_oath_good";
  const OATH_EVIL = "va_oath_evil";
  const OATH_DONE = "va_oath_done";

  // Frigga portrait (PNG for now)
  const DEFAULT_PORTRAIT = "/guildbook/npcs/frigga.gif";

  const dlg = document.getElementById("dlg");
  const dlgName = document.getElementById("dlgName");
  const dlgText = document.getElementById("dlgText");
  const dlgBtns = document.getElementById("dlgBtns");
  const dlgPortrait = document.getElementById("dlgPortrait");

  // Ensure portrait is always visible
  dlgPortrait.src = DEFAULT_PORTRAIT;
  dlgPortrait.style.display = "block";

  function showDialogue({ name, text, buttons = [] }) {
    dlgName.textContent = name || "Frigga";
    dlgText.innerHTML = "";
    dlgBtns.innerHTML = "";
    dlg.classList.remove("hidden");

    // ALWAYS Frigga
    dlgPortrait.src = DEFAULT_PORTRAIT;
    dlgPortrait.style.display = "block";

    if (typeof text === "string") dlgText.textContent = text;
    else dlgText.appendChild(text);

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = "dlgBtn";
      btn.textContent = b.label;
      btn.onclick = b.onClick;
      dlgBtns.appendChild(btn);
    });
  }

  function hideDialogue() {
    dlg.classList.add("hidden");
  }

  async function loadJSON(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load " + url + " (" + res.status + ")");
    return await res.json();
  }

  function getInt(key, fallback = 0) {
    const v = parseInt(localStorage.getItem(key) || "", 10);
    return Number.isFinite(v) ? v : fallback;
  }

  function saveProgress(idx, good, evil) {
    localStorage.setItem("va_save_active", "1");
    localStorage.setItem("va_episode", "volume1_ep1");
    localStorage.setItem("va_screen", "oath_trial");
    localStorage.setItem(OATH_IDX, String(idx));
    localStorage.setItem(OATH_GOOD, String(good));
    localStorage.setItem(OATH_EVIL, String(evil));
  }

  const data = await loadJSON("/data/episodes/volume1_ep1/oath_trial.json");

  // Already finished
  if (localStorage.getItem(OATH_DONE) === "1") {
    const name = localStorage.getItem(NAME_KEY) || "Traveler";
    const align = localStorage.getItem(ALIGN_KEY) || "myriador";
    const result = (align === "dreadheim") ? data.results.dreadheim : data.results.myriador;

    showDialogue({
  name: "Frigga",
  text: result.text.replace("{name}", playerName),
  buttons: [{
    label: result.button,
    onClick: () => {
      hideDialogue();

      if (isDreadheim) {
        window.location.href = "/dreadheimscene1.html";
      } else {
        window.location.href = "/myriadorscene1.html";
      }
    }
  }]
});

    return;
  }

  // Ask name
  if (!localStorage.getItem(NAME_KEY)) {
    await new Promise(resolve => {
      const input = document.createElement("input");
      input.className = "nameInput";
      input.placeholder = "Your name";
      input.maxLength = 18;

      showDialogue({
        name: "Frigga",
        text: (data.namePrompt && data.namePrompt.text) ? data.namePrompt.text : "Speak your name.",
        buttons: [{
          label: "Continue",
          onClick: () => {
            localStorage.setItem(NAME_KEY, (input.value || "").trim() || "Traveler");
            hideDialogue();
            resolve();
          }
        }]
      });

      dlgText.appendChild(input);
      setTimeout(() => input.focus(), 50);
    });
  }

  let idx = getInt(OATH_IDX, 0);
  let good = getInt(OATH_GOOD, 0);
  let evil = getInt(OATH_EVIL, 0);

  // Make it resumable immediately
  saveProgress(idx, good, evil);

  // Ask remaining questions
  while (idx < data.questions.length) {
    const q = data.questions[idx];

    await new Promise(resolve => {
      showDialogue({
        name: "Frigga",
        text: q.text,
        buttons: [
          { label: q.good.label, onClick: () => { good += 1; hideDialogue(); resolve(); } },
          { label: q.evil.label, onClick: () => { evil += 1; hideDialogue(); resolve(); } }
        ]
      });
    });

    idx += 1;
    saveProgress(idx, good, evil);
  }

  // Tiebreaker
  if (good === evil) {
    const q = data.tiebreaker;

    await new Promise(resolve => {
      showDialogue({
        name: "Frigga",
        text: q.text,
        buttons: [
          { label: q.good.label, onClick: () => { good += 1; hideDialogue(); resolve(); } },
          { label: q.evil.label, onClick: () => { evil += 1; hideDialogue(); resolve(); } }
        ]
      });
    });

    saveProgress(idx, good, evil);
  }

  // Decide alignment
  const playerName = localStorage.getItem(NAME_KEY) || "Traveler";
  const isDreadheim = evil > good;

  localStorage.setItem(ALIGN_KEY, isDreadheim ? "dreadheim" : "myriador");
  localStorage.setItem(OATH_DONE, "1");

  const result = isDreadheim ? data.results.dreadheim : data.results.myriador;

  showDialogue({
    name: "Frigga",
    text: result.text.replace("{name}", playerName),
    buttons: [{
      label: result.button,
      onClick: () => {
        hideDialogue();
        alert("Next area: " + result.toScreen);
      }
    }]
  });

});
// ===============================
// DEV TOOLS (F12)
// ===============================
window.VA_DEV = {
  resetEpisode1() {
    console.warn("DEV: Resetting Episode I");

    const keys = [
      "va_player_name",
      "va_alignment",
      "va_episode",
      "va_screen",
      "va_save_active",
      "va_oath_idx",
      "va_oath_good",
      "va_oath_evil",
      "va_oath_done"
    ];

    keys.forEach(k => localStorage.removeItem(k));

    console.warn("DEV: Episode I reset complete");
    console.warn("DEV: Reloading page…");

    location.reload();
  }
};

</script>
</body>
</html>




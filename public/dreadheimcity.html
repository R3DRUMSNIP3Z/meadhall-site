```html
<!-- /public/guildbook/scenes/dreadheim_city.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Veriador â€¢ Dreadheim â€¢ City</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#000;
  font-family:Cinzel, serif;
  overflow:hidden;
}

/* ================= BACKGROUND ================= */
#bg{
  position:fixed;
  inset:0;
  background:url("/guildbook/scenes/maps/dreadheimcityentrance.png") center center / cover no-repeat;
  z-index:0;
}

/* ================= DEV-EDITABLE LAYER (NPC wrappers) ================= */
#npcs{
  position:fixed;
  inset:0;
  z-index:20;
  pointer-events:none; /* only wrappers receive clicks */
}

/* Wrapper that becomes draggable/resizable in DEV */
.devItem{
  position:absolute;
  z-index:25;
  pointer-events:auto;
  user-select:none;
  -webkit-user-drag:none;
  cursor:pointer;
  filter: drop-shadow(0 18px 32px rgba(0,0,0,0.78));
  transition: transform 120ms ease, filter 120ms ease;
}
.devItem:hover{
  transform: scale(1.02);
  filter: drop-shadow(0 22px 38px rgba(0,0,0,0.85))
          drop-shadow(0 0 14px rgba(180,200,255,0.22));
}

/* In DEV mode, show outline + move cursor */
body.devMode .devItem{
  cursor:move;
  outline:1px dashed rgba(255,215,140,.55);
}
.devDragging{
  outline:2px dashed rgba(255,215,140,.88) !important;
  box-shadow:0 0 0 6px rgba(255,215,140,.12) !important;
}

/* The actual NPC image inside wrapper */
.devItem img.npc{
  display:block;
  width:100%;
  height:auto;
  pointer-events:none; /* drag happens on wrapper */
  user-select:none;
  -webkit-user-drag:none;
}

/* resize handles */
.devHandle{
  position:absolute;
  width:14px;
  height:14px;
  border-radius:6px;
  background:rgba(255,215,140,.95);
  border:1px solid rgba(0,0,0,.55);
  display:none;
}
body.devMode .devHandle{ display:block; }
.devHandle.br{ right:-7px; bottom:-7px; cursor:nwse-resize; }
.devHandle.bl{ left:-7px; bottom:-7px; cursor:nesw-resize; }
.devHandle.tr{ right:-7px; top:-7px; cursor:nesw-resize; }
.devHandle.tl{ left:-7px; top:-7px; cursor:nwse-resize; }

/* Dev hint badge */
#devHint{
  position:fixed;
  left:14px;
  bottom:14px;
  z-index:999;
  font-size:14px;
  letter-spacing:.03em;
  color:rgba(255,255,255,0.55);
  text-shadow:0 2px 10px rgba(0,0,0,0.8);
  pointer-events:none;
  display:none;
}
body.devMode #devHint{ display:block; }

/* ================= DIALOGUE ================= */
#dlg{
  position:fixed;
  left:50%;
  bottom:14px;
  transform:translateX(-50%);
  width:min(1200px, calc(100vw - 24px));
  height:190px;
  z-index:999; /* above all */
  display:grid;
  grid-template-columns:240px 1fr;
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(90deg, rgba(35,20,10,.95), rgba(15,10,8,.88));
  border:1px solid rgba(255,208,120,.2);
  box-shadow:0 18px 55px rgba(0,0,0,.6);
}
#dlg.hidden{ display:none !important; }

#dlgPortrait{
  width:240px;
  height:190px;
  object-fit:contain;
  align-self:end;
  filter:drop-shadow(0 12px 22px rgba(0,0,0,0.65));
}
#dlgPanel{
  padding:16px 18px;
  display:grid;
  grid-template-rows:auto 1fr auto;
  gap:10px;
}
#dlgName{
  font-size:28px;
  font-weight:900;
  color:rgba(255,225,170,.95);
}
#dlgText{
  font-size:20px;
  line-height:1.35;
  color:rgba(255,255,255,.95);
  white-space:pre-wrap;
}
#dlgBtns{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
#dlg, #dlgPanel, #dlgBtns, .dlgBtn{ pointer-events:auto; }
.dlgBtn{
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  border:1px solid rgba(255,208,120,.28);
  background:rgba(120,60,25,.45);
  color:rgba(255,245,230,.95);
  font-weight:800;
}
.dlgBtn:hover{ filter:brightness(1.1); }

/* ================= PICKUP POPUP (RING) ================= */
#pickupOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.72);
  z-index:1000;
  display:none;
}
#pickupCard{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  width:min(520px, calc(100vw - 36px));
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(180deg, rgba(35,20,10,.96), rgba(10,8,8,.92));
  border:1px solid rgba(255,208,120,.22);
  box-shadow:0 24px 80px rgba(0,0,0,.75);
  padding:16px;
}
#pickupRow{
  display:flex;
  gap:14px;
  align-items:center;
}
#pickupImg{
  width:96px;
  height:96px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#pickupImg img{
  width:78px;
  height:78px;
  object-fit:contain;
}
#pickupText{
  flex:1;
  line-height:1.35;
  font-size:18px;
  color:rgba(245,240,230,.95);
}
#pickupBtns{
  margin-top:12px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
</style>
</head>

<body>

<div id="bg"></div>

<div id="devHint">DEV MODE ON â€” drag NPCs, resize corners, release to save (prints CSS in console). Press M to toggle.</div>

<!-- ================= NPCS (RESTORED) =================
  Same citizens/slaves you had before.
  Only change: wrapped each one so it can be dragged/resized in DEV mode.
-->
<div id="npcs">
  <div class="devItem" data-id="npcCitizen1" style="left:18%; top:55%; width:90px;">
    <img id="npcCitizen1" class="npc" src="/guildbook/npcs/slaves/blondeman.gif" alt="Street Slave">
    <div class="devHandle tl"></div><div class="devHandle tr"></div><div class="devHandle bl"></div><div class="devHandle br"></div>
  </div>

  <div class="devItem" data-id="npcCitizen2" style="left:36%; top:58%; width:92px;">
    <img id="npcCitizen2" class="npc" src="/guildbook/npcs/slaves/hungrywoman.gif" alt="Hungry Woman">
    <div class="devHandle tl"></div><div class="devHandle tr"></div><div class="devHandle bl"></div><div class="devHandle br"></div>
  </div>

  <div class="devItem" data-id="npcCitizen3" style="left:62%; top:54%; width:110px;">
    <img id="npcCitizen3" class="npc" src="/guildbook/npcs/citizens/helcitizenwoman.gif" alt="Citizen Woman">
    <div class="devHandle tl"></div><div class="devHandle tr"></div><div class="devHandle bl"></div><div class="devHandle br"></div>
  </div>

  <div class="devItem" data-id="npcCitizen4" style="left:82%; top:56%; width:110px;">
    <img id="npcCitizen4" class="npc" src="/guildbook/npcs/citizens/helcitizenman.gif" alt="Citizen Man">
    <div class="devHandle tl"></div><div class="devHandle tr"></div><div class="devHandle bl"></div><div class="devHandle br"></div>
  </div>
</div>

<!-- Dialogue (HIDDEN until NPC click) -->
<div id="dlg" class="hidden" aria-hidden="true">
  <img id="dlgPortrait" alt="Portrait">
  <div id="dlgPanel">
    <div id="dlgName"></div>
    <div id="dlgText"></div>
    <div id="dlgBtns"></div>
  </div>
</div>

<!-- Ring pickup popup -->
<div id="pickupOverlay" aria-hidden="true">
  <div id="pickupCard" role="dialog" aria-label="Item acquired">
    <div id="pickupRow">
      <div id="pickupImg"><img id="pickupImgInner" alt="Item"></div>
      <div id="pickupText"></div>
    </div>
    <div id="pickupBtns"></div>
  </div>
</div>

<!-- âœ… Global UI MUST load before page logic so VAQ exists -->
<script src="/guildbook/js/va_global_ui.js"></script>

<script>
(() => {
  "use strict";

  // ----------------------------
  // Storage keys (same as your city script)
  // ----------------------------
  const GOOD_KEY = "va_good";
  const EVIL_KEY = "va_evil";
  const INV_UNLOCK_KEY = "va_inv_unlocked";
  const INV_ITEMS_KEY  = "va_inv_items";

  // âœ… Quest step markers (same system as Mead Hall)
  const QUEST_ID_KEY = "vaq_activeQuestId";
  const FLAGS_KEY    = "va_flags";
  // âœ… Switch the active quest + catalog (used when City is completed)
function setActiveQuest(id, catalogUrl){
  if (id) localStorage.setItem(QUEST_ID_KEY, id);
  if (catalogUrl) localStorage.setItem("vaq_activeQuestCatalog", catalogUrl);
  try{ window.__vaq_stickyActiveGuard && window.__vaq_stickyActiveGuard(); }catch{}
  try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
}


  // âœ… Default city dialogue JSON + per-NPC done flags
  const DEFAULT_CITY_JSON = "/data/episodes/volume1_ep1/defaultcitydialogue.json";
  const CITY_DONE_KEY = "va_city_done_flags"; // stores { npcCitizen1:true, ... }

  // ----------------------------
  // UI refs
  // ----------------------------
  const dlg = document.getElementById("dlg");
  const dlgName = document.getElementById("dlgName");
  const dlgText = document.getElementById("dlgText");
  const dlgBtns = document.getElementById("dlgBtns");
  const dlgPortrait = document.getElementById("dlgPortrait");

  const pickupOverlay = document.getElementById("pickupOverlay");
  const pickupImgInner = document.getElementById("pickupImgInner");
  const pickupText = document.getElementById("pickupText");
  const pickupBtns = document.getElementById("pickupBtns");

  // ----------------------------
  // Helpers
  // ----------------------------
  function ensureVAQ(){
    return !!(window.VAQ && typeof window.VAQ.txt === "function" && typeof window.VAQ.getNum === "function");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function getNum(key){
    const v = Number(localStorage.getItem(key) || "0");
    return Number.isFinite(v) ? v : 0;
  }
  function setNum(key, n){ localStorage.setItem(key, String(Number(n)||0)); }

  // âœ… Quest flags helpers (same as Mead Hall)
  function getFlags(){
    try{ return JSON.parse(localStorage.getItem(FLAGS_KEY) || "{}"); }
    catch{ return {}; }
  }
  function setFlags(obj){
    localStorage.setItem(FLAGS_KEY, JSON.stringify(obj || {}));
  }

  // âœ… This is what makes âœ“ / âœ• appear in the quest journal
  function setQuestStepStatus(questId, stepIndex, status){
    if (!questId) return;
    const f = getFlags();
    const key = `${questId}_step${stepIndex}`;
    f[key] = status; // "pass" or "fail"
    setFlags(f);

    // If any step FAILS (good choice in evil quest), grant +1 GOOD once per quest
    if (status === "fail"){
      const rewardKey = `${questId}_fail_rewarded`;
      if (!f[rewardKey]){
        f[rewardKey] = true;
        setFlags(f);
        addAlignment("good", 1);
      }
    }

    try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
  }

  // âœ… City "done" flags + default dialogue loader
  function cityDoneGet(){
    try{ return JSON.parse(localStorage.getItem(CITY_DONE_KEY) || "{}"); }
    catch{ return {}; }
  }
  function cityDoneSet(obj){
    localStorage.setItem(CITY_DONE_KEY, JSON.stringify(obj || {}));
  }
  function cityMarkDone(npcId){
    const f = cityDoneGet();
    f[npcId] = true;
    cityDoneSet(f);
  }
  function cityIsDone(npcId){
    const f = cityDoneGet();
    return !!f[npcId];
  }

  let __cityDefaultCache = null;
  async function loadCityDefaultJson(){
    if (__cityDefaultCache) return __cityDefaultCache;
    const res = await fetch(DEFAULT_CITY_JSON, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load defaultcitydialogue.json");
    __cityDefaultCache = await res.json();
    return __cityDefaultCache;
  }

  function cityAllDone(){
  return cityIsDone("npcCitizen1")
      && cityIsDone("npcCitizen2")
      && cityIsDone("npcCitizen3")
      && cityIsDone("npcCitizen4");
}

// prevents firing twice
const CITY_COMPLETE_KEY = "va_city_complete_once";

function onCityMaybeComplete(){
  if (!cityAllDone()) return;

  const f = getFlags();
  if (f[CITY_COMPLETE_KEY]) return; // already awarded

  // âœ… Award Lokiâ€™s Mark flag (used by gotofenrir.json objective "mark")
  f.va_lokis_mark = true;
  f[CITY_COMPLETE_KEY] = true;
  setFlags(f);

  // âœ… Switch quest log to Fenrir quest catalog
  setActiveQuest("dq_go_fenrir", "/data/episodes/volume1_ep1/gotofenrir.json");

  // âœ… Toast + Go Now button
  try{ window.__va_toast && window.__va_toast("You have earned Lokiâ€™s Mark. Now go see Fenrir."); }catch{
    console.log("TOAST: You have earned Lokiâ€™s Mark. Now go see Fenrir.");
  }

  showDialogue({
    speaker: "System",
    portraitSrc: "",
    text: "You have earned Lokiâ€™s Mark. Now go see Fenrir.",
    buttons: [
      {
        label: "Go Now",
        onClick: () => {
          hideDialogue();
          location.href = "/guildbook/scenes/fenrirsforest.html";
        }
      },
      { label: "Close", onClick: hideDialogue }
    ]
  });
}


  function pickLine(arr){
    if (!Array.isArray(arr) || !arr.length) return "â€¦";
    return arr[Math.floor(Math.random() * arr.length)];
  }

  async function showCityDefault(npcKey){
    try{
      const data = await loadCityDefaultJson();
      const d = data?.defaults?.[npcKey];
      if (!d){
        showDialogue({
          speaker: "â€¦",
          portraitSrc: "",
          text: "â€¦",
          buttons: [{ label: "Close", onClick: hideDialogue }]
        });
        return;
      }

      const speaker = d.speaker || "â€¦";
      const portrait = d.portrait || "";
      const line = pickLine(d.lines);

      showDialogue({
        speaker,
        portraitSrc: portrait,
        text: ensureVAQ() ? VAQ.txt(line) : line,
        buttons: [{ label: "Close", onClick: hideDialogue }]
      });
    }catch(err){
      console.warn(err);
      showDialogue({
        speaker: "â€¦",
        portraitSrc: "",
        text: "â€¦",
        buttons: [{ label: "Close", onClick: hideDialogue }]
      });
    }
  }

  // Same overflow behavior you designed
  function addAlignment(kind, delta){
    delta = Number(delta) || 0;
    if (!delta) return;

    for (let i = 0; i < Math.abs(delta); i++){
      if (kind === "good"){
        let g = clamp(getNum(GOOD_KEY), 0, 10);
        let e = clamp(getNum(EVIL_KEY), 0, 10);

        if (delta > 0){
          if (g >= 10){
            if (e > 0) e -= 1;
          } else {
            g += 1;
          }
        } else {
          if (g > 0) g -= 1;
        }
        setNum(GOOD_KEY, g);
        setNum(EVIL_KEY, e);
      } else {
        let g = clamp(getNum(GOOD_KEY), 0, 10);
        let e = clamp(getNum(EVIL_KEY), 0, 10);

        if (delta > 0){
          if (e >= 10){
            if (g > 0) g -= 1;
          } else {
            e += 1;
          }
        } else {
          if (e > 0) e -= 1;
        }
        setNum(GOOD_KEY, g);
        setNum(EVIL_KEY, e);
      }
    }

    try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
  }

  // Inventory (matches global keys)
  function invIsUnlocked(){ return localStorage.getItem(INV_UNLOCK_KEY) === "1"; }
  function invUnlock(){
    localStorage.setItem(INV_UNLOCK_KEY, "1");
    try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
  }
  function invGetItems(){
    try{
      const arr = JSON.parse(localStorage.getItem(INV_ITEMS_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function invSetItems(items){
    localStorage.setItem(INV_ITEMS_KEY, JSON.stringify(Array.isArray(items) ? items : []));
  }
  function invHasItem(id){
    return invGetItems().some(it => it && it.id === id);
  }
  function invAddItem(item){
    if (!item || !item.id) return;
    if (invHasItem(item.id)) return;
    const items = invGetItems();
    items.push(item);
    invSetItems(items);
  }
  function invOpenViaGlobal(){
    const btn = document.getElementById("invBtn");
    if (btn && invIsUnlocked()) btn.click();
  }

  // Dialogue
  function showDialogue({ speaker, text, portraitSrc, buttons = [] }){
    dlgName.textContent = speaker || "";
    dlgText.textContent = (typeof text === "string") ? text : String(text ?? "");
    dlgBtns.innerHTML = "";

    if (portraitSrc) dlgPortrait.src = portraitSrc;

    dlg.classList.remove("hidden");
    dlg.setAttribute("aria-hidden", "false");

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = "dlgBtn";
      btn.type = "button";
      btn.textContent = b.label;

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (typeof b.onClick === "function") b.onClick();
      });

      dlgBtns.appendChild(btn);
    });
  }

  function hideDialogue(){
    dlg.classList.add("hidden");
    dlg.setAttribute("aria-hidden", "true");
    dlgName.textContent = "";
    dlgText.textContent = "";
    dlgBtns.innerHTML = "";
  }

  // Pickup popup
  function pickupShow({ img, textLines = [], primaryLabel = "Open Inventory", onPrimary, secondaryLabel = "Close", onSecondary }){
    pickupImgInner.src = img || "";
    pickupText.innerHTML = textLines.map(line => `<div>${escapeHtml(line)}</div>`).join("");
    pickupBtns.innerHTML = "";

    const b1 = document.createElement("button");
    b1.className = "dlgBtn";
    b1.type = "button";
    b1.textContent = primaryLabel;
    b1.addEventListener("click", () => {
      pickupHide();
      if (typeof onPrimary === "function") onPrimary();
    });

    const b2 = document.createElement("button");
    b2.className = "dlgBtn";
    b2.type = "button";
    b2.textContent = secondaryLabel;
    b2.addEventListener("click", () => {
      pickupHide();
      if (typeof onSecondary === "function") onSecondary();
    });

    pickupBtns.appendChild(b1);
    pickupBtns.appendChild(b2);

    pickupOverlay.style.display = "block";
    pickupOverlay.setAttribute("aria-hidden","false");
  }

  function pickupHide(){
    pickupOverlay.style.display = "none";
    pickupOverlay.setAttribute("aria-hidden","true");
  }

  pickupOverlay.addEventListener("click", (e) => {
    if (e.target === pickupOverlay) pickupHide();
  });

  // ----------------------------
  // NPC Actions (same as your script)
  // ----------------------------
  function doGoodCitizen1(){
    addAlignment("good", 1);
    cityMarkDone("npcCitizen1"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Good choice = FAIL (âœ•)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 0, "fail");

    showDialogue({
      speaker: "Street Slave",
      portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
      text: ensureVAQ() ? VAQ.txt("â€¦You didnâ€™t have to do that. In Dreadheim, kindness is a dangerous habit.") : "â€¦",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen1(){
    addAlignment("evil", 1);
    cityMarkDone("npcCitizen1"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Evil choice = PASS (âœ“)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 0, "pass");

    showDialogue({
      speaker: "Street Slave",
      portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
      text: ensureVAQ() ? VAQ.txt("What do you want from me? If itâ€™s not foodâ€”leave me alone!?") : "â€¦",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doGoodCitizen2(){
    addAlignment("good", 1);
    cityMarkDone("npcCitizen2"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Good choice = FAIL (âœ•)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 1, "fail");

    showDialogue({
      speaker: "Hungry Woman",
      portraitSrc: "/guildbook/npcs/slaves/hungrywoman.gif",
      text: ensureVAQ() ? VAQ.txt("â€¦Thank you. I thought youâ€™d be like the rest of them.") : "â€¦",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doStealRing(){
    addAlignment("evil", 1);
    cityMarkDone("npcCitizen2"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Evil choice = PASS (âœ“)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 1, "pass");

    const RING_ITEM_ID = "slaves_wedding_ring";
    const RING_ITEM_IMG = "/guildbook/props/slavesring.gif";
    const RING_ITEM_NAME = "Wedding Ring (Slaveâ€™s Keepsake)";

    invUnlock();
    invAddItem({ id: RING_ITEM_ID, name: RING_ITEM_NAME, img: RING_ITEM_IMG });

    pickupShow({
      img: RING_ITEM_IMG,
      textLines: [
        "You rummage through her sack that is being used as bottom coverâ€¦",
        "and find a special memento the slave cherishes:",
        "her dead husbandâ€™s wedding ring."
      ],
      primaryLabel: "Open Inventory",
      onPrimary: () => invOpenViaGlobal(),
      secondaryLabel: "Close"
    });
  }

  function doGoodCitizen3(){
    addAlignment("good", 1);
    cityMarkDone("npcCitizen3"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Good choice = FAIL (âœ•)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 2, "fail");

    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
      text: ensureVAQ() ? VAQ.txt("â€¦You spared me. Thatâ€™s rarer than gold in Dreadheim.") : "â€¦",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen3(){
    addAlignment("evil", 1);
    cityMarkDone("npcCitizen3"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Evil choice = PASS (âœ“)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 2, "pass");

    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
      text: ensureVAQ() ? VAQ.txt("Youâ€™ve already done enoughâ€¦ leave me be.") : "â€¦",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doGoodCitizen4(){
    addAlignment("good", 1);
    cityMarkDone("npcCitizen4"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Good choice = FAIL (âœ•)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 3, "fail");

    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
      text: ensureVAQ() ? VAQ.txt("Hmph. You chose restraint. Smartâ€”here, mercy costs.") : "â€¦",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen4(){
    addAlignment("evil", 1);
    cityMarkDone("npcCitizen4"); // âœ… mark done
    onCityMaybeComplete();


    // âœ… Quest step marker: Evil choice = PASS (âœ“)
    const qid = localStorage.getItem(QUEST_ID_KEY) || "";
    setQuestStepStatus(qid, 3, "pass");

    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
      text: ensureVAQ() ? VAQ.txt("Keep your eyes down. Dreadheim doesnâ€™t forgive curiosity.") : "â€¦",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  // ----------------------------
  // DEV: DRAG + RESIZE (MeadHall style) â€” press M
  // ----------------------------
  const DEV_KEY = "va_scene_dev";
  const POS_KEY = "va_scene_props_" + location.pathname;

  let devMode = localStorage.getItem(DEV_KEY) === "1";
  document.body.classList.toggle("devMode", devMode);

  const items = [...document.querySelectorAll("#npcs .devItem")];

  function getSaved(){
    try{ return JSON.parse(localStorage.getItem(POS_KEY) || "{}"); }
    catch{ return {}; }
  }

  function applySaved(){
    const s = getSaved();
    items.forEach(el => {
      const id = el.dataset.id;
      const v = s[id];
      if (!v) return;
      if (v.left) el.style.left = v.left;
      if (v.top) el.style.top = v.top;
      if (v.width) el.style.width = v.width;
      if (v.height && v.height !== "auto") el.style.height = v.height;
    });
  }

  function saveOne(el){
    const id = el.dataset.id;
    if (!id) return;

    const s = getSaved();
    s[id] = {
      left: el.style.left,
      top: el.style.top,
      width: el.style.width,
      height: el.style.height || "auto"
    };
    localStorage.setItem(POS_KEY, JSON.stringify(s));

    console.log(`ðŸ“Œ ${id} â†’ left:${s[id].left}; top:${s[id].top}; width:${s[id].width}; height:${s[id].height};`);
  }

  applySaved();

  function pctX(px){ return (px / window.innerWidth * 100).toFixed(2) + "%"; }
  function pctY(py){ return (py / window.innerHeight * 100).toFixed(2) + "%"; }

  let active = null;
  let mode = null; // "drag" | "resize"
  let handle = "br";
  let sx=0, sy=0, sl=0, st=0, sw=0;

  function onMouseMove(e){
    if (!devMode || !active) return;

    if (mode === "drag"){
      const nl = sl + (e.clientX - sx);
      const nt = st + (e.clientY - sy);
      active.style.left = pctX(nl);
      active.style.top  = pctY(nt);
      return;
    }

    // resize width only (keeps gif aspect)
    const dx = e.clientX - sx;
    let newW = sw;

    if (handle === "br" || handle === "tr") newW = sw + dx;
    if (handle === "bl" || handle === "tl") newW = sw - dx;

    newW = Math.max(24, newW);
    active.style.width = newW + "px";

    // if resizing from left corners, keep corner pinned
    if (handle === "bl" || handle === "tl"){
      const nl = sl + dx;
      active.style.left = pctX(nl);
    }
  }

  function onMouseUp(){
    if (!active) return;
    active.classList.remove("devDragging");
    saveOne(active);
    active = null;
    mode = null;
  }

  items.forEach(el => {
    // drag on wrapper (ignore handles)
    el.addEventListener("mousedown", (e) => {
      if (!devMode) return;
      if (e.target && e.target.classList && e.target.classList.contains("devHandle")) return;

      const r = el.getBoundingClientRect();
      active = el;
      mode = "drag";
      sx = e.clientX; sy = e.clientY;
      sl = r.left;   st = r.top;

      el.classList.add("devDragging");
      e.preventDefault();
      e.stopPropagation();
    });

    // resize handles
    el.querySelectorAll(".devHandle").forEach(h => {
      h.addEventListener("mousedown", (e) => {
        if (!devMode) return;

        const r = el.getBoundingClientRect();
        active = el;
        mode = "resize";
        handle = [...h.classList].find(c => ["tl","tr","bl","br"].includes(c)) || "br";

        sx = e.clientX; sy = e.clientY;
        sl = r.left;   st = r.top;
        sw = r.width;

        el.classList.add("devDragging");
        e.preventDefault();
        e.stopPropagation();
      });
    });
  });

  window.addEventListener("mousemove", onMouseMove);
  window.addEventListener("mouseup", onMouseUp);

  // toggle dev mode with M
  window.addEventListener("keydown", (e) => {
    if (e.key && e.key.toLowerCase() === "m"){
      devMode = !devMode;
      localStorage.setItem(DEV_KEY, devMode ? "1" : "0");
      document.body.classList.toggle("devMode", devMode);
      console.log(devMode ? "ðŸ›  DEV MODE ON" : "ðŸ§­ DEV MODE OFF");
    }
  });

  // ----------------------------
  // Click wiring (same options as your script)
  // IMPORTANT: block dialogue while in devMode
  // ----------------------------
  function bindNpcClicks(){
    document.querySelector('[data-id="npcCitizen1"]').addEventListener("click", async (e) => {
      if (devMode) return;
      e.preventDefault(); e.stopPropagation();

      // âœ… after first completion, default to JSON lines
      if (cityIsDone("npcCitizen1")){
        await showCityDefault("npcCitizen1");
        return;
      }

      const t = ensureVAQ() ? VAQ.txt("What do you want from me, if its not food leave me alone!?") : "â€¦";
      showDialogue({
        speaker: "Street Slave",
        portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
        text: t,
        buttons: [
          { label: "Give Food (Good)", onClick: doGoodCitizen1 },
          { label: "Intimidate (Evil)", onClick: doEvilCitizen1 },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    });

    document.querySelector('[data-id="npcCitizen2"]').addEventListener("click", async (e) => {
      if (devMode) return;
      e.preventDefault(); e.stopPropagation();

      // âœ… after first completion, default to JSON lines
      if (cityIsDone("npcCitizen2")){
        await showCityDefault("npcCitizen2");
        return;
      }

      const t = ensureVAQ() ? VAQ.txt("Pleaseâ€¦ I have nothing worth taking.") : "â€¦";
      showDialogue({
        speaker: "Hungry Woman",
        portraitSrc: "/guildbook/npcs/slaves/hungrywoman.gif",
        text: t,
        buttons: [
          { label: "Leave Something (Good)", onClick: doGoodCitizen2 },
          { label: "Steal It (Evil)", onClick: doStealRing },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    });

    document.querySelector('[data-id="npcCitizen3"]').addEventListener("click", async (e) => {
      if (devMode) return;
      e.preventDefault(); e.stopPropagation();

      // âœ… after first completion, default to JSON lines
      if (cityIsDone("npcCitizen3")){
        await showCityDefault("npcCitizen3");
        return;
      }

      const t = ensureVAQ() ? VAQ.txt("Youâ€™ve already done enoughâ€¦ leave me be.") : "â€¦";
      showDialogue({
        speaker: "Citizen",
        portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
        text: t,
        buttons: [
          { label: "Spare Her (Good)", onClick: doGoodCitizen3 },
          { label: "Report Back (Cold) (Evil)", onClick: doEvilCitizen3 },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    });

    document.querySelector('[data-id="npcCitizen4"]').addEventListener("click", async (e) => {
      if (devMode) return;
      e.preventDefault(); e.stopPropagation();

      // âœ… after first completion, default to JSON lines
      if (cityIsDone("npcCitizen4")){
        await showCityDefault("npcCitizen4");
        return;
      }

      const t = ensureVAQ() ? VAQ.txt("Keep your eyes down. Dreadheim doesnâ€™t forgive curiosity.") : "â€¦";
      showDialogue({
        speaker: "Citizen",
        portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
        text: t,
        buttons: [
          { label: "Nod + Move On (Good)", onClick: doGoodCitizen4 },
          { label: "Threaten Him (Evil)", onClick: doEvilCitizen4 },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    });
  }

  // ----------------------------
  // Boot
  // ----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    if (!ensureVAQ()){
      console.warn("VAQ missing. Make sure /guildbook/js/va_global_ui.js is loading.");
    }

    bindNpcClicks();

    // ESC closes dialogue + pickup
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        hideDialogue();
        pickupHide();
      }
    });

    // start hidden
    hideDialogue();
    pickupHide();
  });

})();
</script>

</body>
</html>
```

```











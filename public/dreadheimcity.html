<!-- /public/guildbook/scenes/dreadheim_city.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Veriador • Dreadheim • City</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#000;
  font-family:Cinzel, serif;
  overflow:hidden;
}

/* ================= BACKGROUND ================= */
#bg{
  position:fixed;
  inset:0;
  background:url("/guildbook/scenes/maps/dreadheimcityentrance.png") center center / cover no-repeat;
  z-index:0;
}

/* ================= DEV PANEL ================= */
#devPanel{
  position:fixed;
  left:14px;
  top:14px;
  z-index:2000;
  display:none;
  padding:12px 12px 10px;
  border-radius:14px;
  background:rgba(0,0,0,.78);
  border:1px solid rgba(255,208,120,.25);
  box-shadow:0 18px 55px rgba(0,0,0,.65);
  color:rgba(255,240,220,.95);
  font-size:14px;
  line-height:1.25;
  user-select:none;
  text-shadow:0 2px 8px rgba(0,0,0,.8);
}
body.devMode #devPanel{ display:block; }

#devPanel .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
#devPanel button{
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
  border:1px solid rgba(255,208,120,.25);
  background:rgba(120,60,25,.35);
  color:rgba(255,245,230,.95);
  font-weight:800;
}
#devPanel button:hover{ filter:brightness(1.1); }

#devHint{
  opacity:.9;
  font-size:12px;
  margin-top:8px;
}

/* ================= DEV PROPS LAYER (DRAG + RESIZE) ================= */
#props{
  position:fixed;
  inset:0;
  z-index:12;
  pointer-events:none; /* normal mode: ignore */
}
body.devMode #props{
  pointer-events:auto; /* dev mode: clickable */
}

/* generic draggable box (props + npcs in dev mode) */
.draggable{
  position:absolute;
  pointer-events:auto;
  user-select:none;
  -webkit-user-drag:none;
  touch-action:none;
}
.draggable img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
  filter:drop-shadow(0 18px 30px rgba(0,0,0,0.75));
}

/* drag handle overlays the whole element */
.draggable .handle{
  position:absolute;
  inset:0;
  cursor:grab;
}
body.devMode .draggable.dragging .handle{ cursor:grabbing; }

/* resize nub */
.draggable .resize{
  position:absolute;
  right:-10px;
  bottom:-10px;
  width:18px;
  height:18px;
  border-radius:6px;
  background:rgba(255,210,150,.85);
  border:1px solid rgba(0,0,0,.35);
  box-shadow:0 10px 18px rgba(0,0,0,.55);
  cursor:nwse-resize;
  display:none;
}
body.devMode .draggable .resize{ display:block; }

/* ================= NPCS LAYER ================= */
#npcs{
  position:fixed;
  inset:0;
  z-index:20;
  pointer-events:none; /* allow only NPCs to receive clicks */
}
.npcWrap{
  position:absolute;
  z-index:25;
  pointer-events:auto;
}
body:not(.devMode) .npcWrap{ cursor:pointer; }
body.devMode .npcWrap{ cursor:default; }

.npcImg{
  width:100%;
  height:auto;
  display:block;
  pointer-events:none; /* wrapper handles clicks */
  user-select:none;
  -webkit-user-drag:none;
  filter: drop-shadow(0 18px 32px rgba(0,0,0,0.78));
  transition: transform 120ms ease, filter 120ms ease;
}
body:not(.devMode) .npcWrap:hover .npcImg{
  transform: scale(1.02);
  filter: drop-shadow(0 22px 38px rgba(0,0,0,0.85))
          drop-shadow(0 0 14px rgba(180,200,255,0.22));
}

/* ================= DIALOGUE ================= */
#dlg{
  position:fixed;
  left:50%;
  bottom:14px;
  transform:translateX(-50%);
  width:min(1200px, calc(100vw - 24px));
  height:190px;
  z-index:999; /* must be above HUD */
  display:grid;
  grid-template-columns:240px 1fr;
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(90deg, rgba(35,20,10,.95), rgba(15,10,8,.88));
  border:1px solid rgba(255,208,120,.2);
  box-shadow:0 18px 55px rgba(0,0,0,.6);
}
#dlg.hidden{ display:none !important; }

#dlgPortrait{
  width:240px;
  height:190px;
  object-fit:contain;
  align-self:end;
  filter:drop-shadow(0 12px 22px rgba(0,0,0,0.65));
}

#dlgPanel{
  padding:16px 18px;
  display:grid;
  grid-template-rows:auto 1fr auto;
  gap:10px;
}

#dlgName{
  font-size:28px;
  font-weight:900;
  color:rgba(255,225,170,.95);
}

#dlgText{
  font-size:20px;
  line-height:1.35;
  color:rgba(255,255,255,.95);
  white-space:pre-wrap;
}

#dlgBtns{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}

#dlg, #dlgPanel, #dlgBtns, .dlgBtn{ pointer-events:auto; }

.dlgBtn{
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  border:1px solid rgba(255,208,120,.28);
  background:rgba(120,60,25,.45);
  color:rgba(255,245,230,.95);
  font-weight:800;
}
.dlgBtn:hover{ filter:brightness(1.1); }

/* ================= PICKUP POPUP (RING) ================= */
#pickupOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.72);
  z-index:1000;
  display:none;
}
#pickupCard{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  width:min(520px, calc(100vw - 36px));
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(180deg, rgba(35,20,10,.96), rgba(10,8,8,.92));
  border:1px solid rgba(255,208,120,.22);
  box-shadow:0 24px 80px rgba(0,0,0,.75);
  padding:16px;
}
#pickupRow{
  display:flex;
  gap:14px;
  align-items:center;
}
#pickupImg{
  width:96px;
  height:96px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#pickupImg img{
  width:78px;
  height:78px;
  object-fit:contain;
}
#pickupText{
  flex:1;
  line-height:1.35;
  font-size:18px;
  color:rgba(245,240,230,.95);
}
#pickupBtns{
  margin-top:12px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
</style>
</head>

<body>

<div id="bg"></div>

<!-- DEV panel (only visible in devMode) -->
<div id="devPanel">
  <div style="font-weight:900; letter-spacing:.06em; color:rgba(255,215,140,1);">DEV MODE</div>
  <div id="devHint">
    Drag = move • Corner nub = resize • Saves automatically<br>
    Toggle: <b>Ctrl+Shift+D</b> • Copy layout: <b>Ctrl+Shift+C</b> • Reset: <b>Ctrl+Shift+R</b>
  </div>
  <div class="row">
    <button id="btnCopy">Copy Layout JSON</button>
    <button id="btnReset">Reset Saved Layout</button>
    <button id="btnToggle">Exit Dev</button>
  </div>
</div>

<!-- Optional dev props you can add/drag/resize while in devMode -->
<div id="props" aria-hidden="true">
  <!-- Add props like this (they become draggable/resizable in devMode):
  <div class="draggable" data-kind="prop" data-id="crate1" style="left:10%; top:62%; width:140px; height:140px;">
    <div class="handle"></div>
    <img src="/guildbook/props/crate.png" alt="">
    <div class="resize"></div>
  </div>
  -->
</div>

<div id="npcs">
  <!-- NPCs wrapped so we can make them draggable in devMode without breaking normal clicks -->
  <div id="npcCitizen1" class="npcWrap draggable" data-kind="npc" data-id="npcCitizen1" style="left:18%; top:55%; width:90px;">
    <div class="handle"></div>
    <img class="npcImg" src="/guildbook/npcs/slaves/blondeman.gif" alt="Street Slave">
    <div class="resize"></div>
  </div>

  <div id="npcCitizen2" class="npcWrap draggable" data-kind="npc" data-id="npcCitizen2" style="left:36%; top:58%; width:92px;">
    <div class="handle"></div>
    <img class="npcImg" src="/guildbook/npcs/slaves/hungrywoman.gif" alt="Hungry Woman">
    <div class="resize"></div>
  </div>

  <div id="npcCitizen3" class="npcWrap draggable" data-kind="npc" data-id="npcCitizen3" style="left:62%; top:54%; width:110px;">
    <div class="handle"></div>
    <img class="npcImg" src="/guildbook/npcs/citizens/helcitizenwoman.gif" alt="Citizen Woman">
    <div class="resize"></div>
  </div>

  <div id="npcCitizen4" class="npcWrap draggable" data-kind="npc" data-id="npcCitizen4" style="left:82%; top:56%; width:110px;">
    <div class="handle"></div>
    <img class="npcImg" src="/guildbook/npcs/citizens/helcitizenman.gif" alt="Citizen Man">
    <div class="resize"></div>
  </div>
</div>

<!-- Dialogue (HIDDEN until NPC click) -->
<div id="dlg" class="hidden" aria-hidden="true">
  <img id="dlgPortrait" alt="Portrait">
  <div id="dlgPanel">
    <div id="dlgName"></div>
    <div id="dlgText"></div>
    <div id="dlgBtns"></div>
  </div>
</div>

<!-- Ring pickup popup -->
<div id="pickupOverlay" aria-hidden="true">
  <div id="pickupCard" role="dialog" aria-label="Item acquired">
    <div id="pickupRow">
      <div id="pickupImg"><img id="pickupImgInner" alt="Item"></div>
      <div id="pickupText"></div>
    </div>
    <div id="pickupBtns"></div>
  </div>
</div>

<!-- ✅ Global UI MUST load before page logic so VAQ exists -->
<script src="/guildbook/js/va_global_ui.js"></script>

<script>
(() => {
  "use strict";

  // ----------------------------
  // Page-level keys (same as global)
  // ----------------------------
  const GOOD_KEY = "va_good";
  const EVIL_KEY = "va_evil";
  const INV_UNLOCK_KEY = "va_inv_unlocked";
  const INV_ITEMS_KEY  = "va_inv_items";

  // Layout save key (unique to this page)
  const LAYOUT_KEY = "va_layout_dreadheim_city";

  // ----------------------------
  // UI refs
  // ----------------------------
  const dlg = document.getElementById("dlg");
  const dlgName = document.getElementById("dlgName");
  const dlgText = document.getElementById("dlgText");
  const dlgBtns = document.getElementById("dlgBtns");
  const dlgPortrait = document.getElementById("dlgPortrait");

  const pickupOverlay = document.getElementById("pickupOverlay");
  const pickupImgInner = document.getElementById("pickupImgInner");
  const pickupText = document.getElementById("pickupText");
  const pickupBtns = document.getElementById("pickupBtns");

  const btnCopy = document.getElementById("btnCopy");
  const btnReset = document.getElementById("btnReset");
  const btnToggle = document.getElementById("btnToggle");

  // ----------------------------
  // Helpers
  // ----------------------------
  function ensureVAQ(){
    return !!(window.VAQ && typeof window.VAQ.txt === "function");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function getNum(key){
    const v = Number(localStorage.getItem(key) || "0");
    return Number.isFinite(v) ? v : 0;
  }
  function setNum(key, n){ localStorage.setItem(key, String(Number(n)||0)); }

  // Same overflow behavior you designed
  function addAlignment(kind, delta){
    delta = Number(delta) || 0;
    if (!delta) return;

    for (let i = 0; i < Math.abs(delta); i++){
      if (kind === "good"){
        let g = clamp(getNum(GOOD_KEY), 0, 10);
        let e = clamp(getNum(EVIL_KEY), 0, 10);

        if (delta > 0){
          if (g >= 10){
            if (e > 0) e -= 1;
          } else {
            g += 1;
          }
        } else {
          if (g > 0) g -= 1;
        }
        setNum(GOOD_KEY, g);
        setNum(EVIL_KEY, e);
      } else {
        let g = clamp(getNum(GOOD_KEY), 0, 10);
        let e = clamp(getNum(EVIL_KEY), 0, 10);

        if (delta > 0){
          if (e >= 10){
            if (g > 0) g -= 1;
          } else {
            e += 1;
          }
        } else {
          if (e > 0) e -= 1;
        }
        setNum(GOOD_KEY, g);
        setNum(EVIL_KEY, e);
      }
    }

    try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
  }

  // Inventory (matches global keys)
  function invIsUnlocked(){ return localStorage.getItem(INV_UNLOCK_KEY) === "1"; }
  function invUnlock(){
    localStorage.setItem(INV_UNLOCK_KEY, "1");
    try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
  }
  function invGetItems(){
    try{
      const arr = JSON.parse(localStorage.getItem(INV_ITEMS_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function invSetItems(items){
    localStorage.setItem(INV_ITEMS_KEY, JSON.stringify(Array.isArray(items) ? items : []));
  }
  function invHasItem(id){
    return invGetItems().some(it => it && it.id === id);
  }
  function invAddItem(item){
    if (!item || !item.id) return;
    if (invHasItem(item.id)) return;
    const items = invGetItems();
    items.push(item);
    invSetItems(items);
  }
  function invOpenViaGlobal(){
    const btn = document.getElementById("invBtn");
    if (btn && invIsUnlocked()) btn.click();
  }

  // Dialogue
  function showDialogue({ speaker, text, portraitSrc, buttons = [] }){
    dlgName.textContent = speaker || "";
    dlgText.textContent = (typeof text === "string") ? text : String(text ?? "");
    dlgBtns.innerHTML = "";

    if (portraitSrc) dlgPortrait.src = portraitSrc;

    dlg.classList.remove("hidden");
    dlg.setAttribute("aria-hidden", "false");

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = "dlgBtn";
      btn.type = "button";
      btn.textContent = b.label;

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (typeof b.onClick === "function") b.onClick();
      });

      dlgBtns.appendChild(btn);
    });
  }

  function hideDialogue(){
    dlg.classList.add("hidden");
    dlg.setAttribute("aria-hidden", "true");
    dlgName.textContent = "";
    dlgText.textContent = "";
    dlgBtns.innerHTML = "";
  }

  // Pickup popup
  function pickupShow({ img, textLines = [], primaryLabel = "Open Inventory", onPrimary, secondaryLabel = "Close", onSecondary }){
    pickupImgInner.src = img || "";
    pickupText.innerHTML = textLines.map(line => `<div>${escapeHtml(line)}</div>`).join("");
    pickupBtns.innerHTML = "";

    const b1 = document.createElement("button");
    b1.className = "dlgBtn";
    b1.type = "button";
    b1.textContent = primaryLabel;
    b1.addEventListener("click", () => {
      pickupHide();
      if (typeof onPrimary === "function") onPrimary();
    });

    const b2 = document.createElement("button");
    b2.className = "dlgBtn";
    b2.type = "button";
    b2.textContent = secondaryLabel;
    b2.addEventListener("click", () => {
      pickupHide();
      if (typeof onSecondary === "function") onSecondary();
    });

    pickupBtns.appendChild(b1);
    pickupBtns.appendChild(b2);

    pickupOverlay.style.display = "block";
    pickupOverlay.setAttribute("aria-hidden","false");
  }

  function pickupHide(){
    pickupOverlay.style.display = "none";
    pickupOverlay.setAttribute("aria-hidden","true");
  }

  pickupOverlay.addEventListener("click", (e) => {
    if (e.target === pickupOverlay) pickupHide();
  });

  // ----------------------------
  // ✅ DEV LAYOUT SAVE/RESTORE
  // ----------------------------
  function readLayout(){
    try{
      const j = JSON.parse(localStorage.getItem(LAYOUT_KEY) || "null");
      return (j && typeof j === "object") ? j : { items:{} };
    }catch{
      return { items:{} };
    }
  }
  function writeLayout(layout){
    localStorage.setItem(LAYOUT_KEY, JSON.stringify(layout || { items:{} }));
  }

  function snapshotEl(el){
    // Use computed px values from getBoundingClientRect, then store as px strings.
    const r = el.getBoundingClientRect();
    return {
      left: Math.round(r.left) + "px",
      top: Math.round(r.top) + "px",
      width: Math.round(r.width) + "px",
      height: Math.round(r.height) + "px"
    };
  }

  function applySavedLayout(){
    const layout = readLayout();
    const items = layout.items || {};
    document.querySelectorAll(".draggable[data-id]").forEach(el => {
      const id = el.getAttribute("data-id");
      const saved = items[id];
      if (!saved) return;

      if (saved.left) el.style.left = saved.left;
      if (saved.top) el.style.top = saved.top;
      if (saved.width) el.style.width = saved.width;

      // Only apply height if element uses it (props do; npc wrappers can ignore height safely)
      if (saved.height && el.getAttribute("data-kind") === "prop"){
        el.style.height = saved.height;
      }
    });
  }

  function saveOne(el){
    const id = el.getAttribute("data-id");
    if (!id) return;
    const layout = readLayout();
    layout.items = layout.items || {};
    layout.items[id] = snapshotEl(el);

    // If npc: keep height out (NPCs are auto-height)
    if (el.getAttribute("data-kind") === "npc"){
      delete layout.items[id].height;
    }
    writeLayout(layout);
  }

  async function copyLayoutToClipboard(){
    const layout = readLayout();
    const pretty = JSON.stringify(layout, null, 2);
    try{
      await navigator.clipboard.writeText(pretty);
      toast("Layout copied ✅");
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = pretty;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); toast("Layout copied ✅"); }catch{ toast("Copy failed ❌"); }
      ta.remove();
    }
  }

  function resetLayout(){
    localStorage.removeItem(LAYOUT_KEY);
    toast("Saved layout cleared.");
    // reload to restore defaults from inline styles
    location.reload();
  }

  // Small toast (uses your global if present; else quick inline)
  function toast(msg){
    try{
      if (typeof window.showToast === "function") { window.showToast(msg); return; }
    }catch{}
    console.log(msg);
  }

  // ----------------------------
  // ✅ DEV DRAG/RESIZE (NPCs + Props)
  // ----------------------------
  function bootDevDragResize(){
    const els = Array.from(document.querySelectorAll(".draggable"));

    let dragEl = null;
    let startX=0, startY=0, startL=0, startT=0;

    let rezEl = null;
    let rsX=0, rsY=0, rsW=0, rsH=0;

    function pxToNum(v){ return Number(String(v||"0").replace("px","")) || 0; }

    function onMove(e){
      const x = (e.touches ? e.touches[0].clientX : e.clientX);
      const y = (e.touches ? e.touches[0].clientY : e.clientY);

      if (dragEl){
        const dx = x - startX;
        const dy = y - startY;
        dragEl.style.left = (startL + dx) + "px";
        dragEl.style.top  = (startT + dy) + "px";
      }
      if (rezEl){
        const dx = x - rsX;
        const dy = y - rsY;
        const newW = Math.max(30, rsW + dx);
        rezEl.style.width = newW + "px";

        // Only props use height resize; NPC wrappers stay auto-height (but can still “resize” by width)
        if (rezEl.getAttribute("data-kind") === "prop"){
          rezEl.style.height = Math.max(30, rsH + dy) + "px";
        }
      }
    }

    function onUp(){
      if (dragEl){
        dragEl.classList.remove("dragging");
        saveOne(dragEl);
        dragEl = null;
      }
      if (rezEl){
        saveOne(rezEl);
        rezEl = null;
      }
      window.removeEventListener("mousemove", onMove);
      window.removeEventListener("mouseup", onUp);
      window.removeEventListener("touchmove", onMove, {passive:false});
      window.removeEventListener("touchend", onUp);
    }

    els.forEach(el => {
      const handle = el.querySelector(".handle");
      const resize = el.querySelector(".resize");

      if (handle){
        const down = (e) => {
          if (!document.body.classList.contains("devMode")) return;
          e.preventDefault();

          const r = el.getBoundingClientRect();
          dragEl = el;
          dragEl.classList.add("dragging");

          startX = (e.touches ? e.touches[0].clientX : e.clientX);
          startY = (e.touches ? e.touches[0].clientY : e.clientY);

          // Convert to px for stable dragging
          el.style.left = Math.round(r.left) + "px";
          el.style.top  = Math.round(r.top) + "px";

          startL = pxToNum(el.style.left);
          startT = pxToNum(el.style.top);

          window.addEventListener("mousemove", onMove);
          window.addEventListener("mouseup", onUp);
          window.addEventListener("touchmove", onMove, {passive:false});
          window.addEventListener("touchend", onUp);
        };
        handle.addEventListener("mousedown", down);
        handle.addEventListener("touchstart", down, {passive:false});
      }

      if (resize){
        const downR = (e) => {
          if (!document.body.classList.contains("devMode")) return;
          e.preventDefault();

          const r = el.getBoundingClientRect();
          rezEl = el;

          rsX = (e.touches ? e.touches[0].clientX : e.clientX);
          rsY = (e.touches ? e.touches[0].clientY : e.clientY);

          // Convert to px so resizing is stable
          el.style.width  = Math.round(r.width) + "px";
          if (el.getAttribute("data-kind") === "prop"){
            el.style.height = Math.round(r.height) + "px";
          }

          rsW = pxToNum(el.style.width);
          rsH = pxToNum(el.style.height);

          window.addEventListener("mousemove", onMove);
          window.addEventListener("mouseup", onUp);
          window.addEventListener("touchmove", onMove, {passive:false});
          window.addEventListener("touchend", onUp);
        };
        resize.addEventListener("mousedown", downR);
        resize.addEventListener("touchstart", downR, {passive:false});
      }
    });
  }

  // ----------------------------
  // NPC Actions
  // ----------------------------
  function doGoodCitizen1(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Street Slave",
      portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
      text: ensureVAQ() ? VAQ.txt("…You didn’t have to do that. In Dreadheim, kindness is a dangerous habit.") : "…",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen1(){
    addAlignment("evil", 1);
    showDialogue({
      speaker: "Street Slave",
      portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
      text: ensureVAQ() ? VAQ.txt("What do you want from me? If it’s not food—leave me alone!?") : "…",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doGoodCitizen2(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Hungry Woman",
      portraitSrc: "/guildbook/npcs/slaves/hungrywoman.gif",
      text: ensureVAQ() ? VAQ.txt("…Thank you. I thought you’d be like the rest of them.") : "…",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doStealRing(){
    addAlignment("evil", 1);

    const RING_ITEM_ID = "slaves_wedding_ring";
    const RING_ITEM_IMG = "/guildbook/props/slavesring.gif";
    const RING_ITEM_NAME = "Wedding Ring (Slave’s Keepsake)";

    invUnlock();
    invAddItem({ id: RING_ITEM_ID, name: RING_ITEM_NAME, img: RING_ITEM_IMG });

    pickupShow({
      img: RING_ITEM_IMG,
      textLines: [
        "You rummage through her sack that is being used as bottom cover…",
        "and find a special memento the slave cherishes:",
        "her dead husband’s wedding ring."
      ],
      primaryLabel: "Open Inventory",
      onPrimary: () => invOpenViaGlobal(),
      secondaryLabel: "Close"
    });
  }

  function doGoodCitizen3(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
      text: ensureVAQ() ? VAQ.txt("…You spared me. That’s rarer than gold in Dreadheim.") : "…",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen3(){
    addAlignment("evil", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
      text: ensureVAQ() ? VAQ.txt("You’ve already done enough… leave me be.") : "…",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doGoodCitizen4(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
      text: ensureVAQ() ? VAQ.txt("Hmph. You chose restraint. Smart—here, mercy costs.") : "…",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen4(){
    addAlignment("evil", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
      text: ensureVAQ() ? VAQ.txt("Keep your eyes down. Dreadheim doesn’t forgive curiosity.") : "…",
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  // ----------------------------
  // ✅ Dev Mode Toggle + Hotkeys
  // ----------------------------
  function setDevMode(on){
    document.body.classList.toggle("devMode", !!on);
    localStorage.setItem("va_devMode", on ? "1" : "0");
  }
  function getDevMode(){
    return localStorage.getItem("va_devMode") === "1";
  }

  function bindDevButtons(){
    btnCopy.addEventListener("click", copyLayoutToClipboard);
    btnReset.addEventListener("click", resetLayout);
    btnToggle.addEventListener("click", () => setDevMode(false));
  }

  // ----------------------------
  // Boot
  // ----------------------------
  document.addEventListener("DOMContentLoaded", () => {

    // Restore saved dev toggle state
    setDevMode(getDevMode());

    // Apply saved layout FIRST (so your hand-tuned positions come back)
    applySavedLayout();

    // Boot drag/resize system
    bootDevDragResize();
    bindDevButtons();

    // Normal NPC click wiring (disabled while devMode is on)
    function npcClickGuard(fn){
      return (e) => {
        if (document.body.classList.contains("devMode")) return; // dev mode: don't trigger dialogue
        fn(e);
      };
    }

    document.getElementById("npcCitizen1").addEventListener("click", npcClickGuard(() => {
      const t = ensureVAQ() ? VAQ.txt("What do you want from me, if its not food leave me alone!?") : "…";
      showDialogue({
        speaker: "Street Slave",
        portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
        text: t,
        buttons: [
          { label: "Give Food (Good)", onClick: doGoodCitizen1 },
          { label: "Intimidate (Evil)", onClick: doEvilCitizen1 },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    }));

    document.getElementById("npcCitizen2").addEventListener("click", npcClickGuard(() => {
      const t = ensureVAQ() ? VAQ.txt("Please… I have nothing worth taking.") : "…";
      showDialogue({
        speaker: "Hungry Woman",
        portraitSrc: "/guildbook/npcs/slaves/hungrywoman.gif",
        text: t,
        buttons: [
          { label: "Leave Something (Good)", onClick: doGoodCitizen2 },
          { label: "Steal It (Evil)", onClick: doStealRing },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    }));

    document.getElementById("npcCitizen3").addEventListener("click", npcClickGuard(() => {
      const t = ensureVAQ() ? VAQ.txt("You’ve already done enough… leave me be.") : "…";
      showDialogue({
        speaker: "Citizen",
        portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
        text: t,
        buttons: [
          { label: "Spare Her (Good)", onClick: doGoodCitizen3 },
          { label: "Report Back (Cold) (Evil)", onClick: doEvilCitizen3 },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    }));

    document.getElementById("npcCitizen4").addEventListener("click", npcClickGuard(() => {
      const t = ensureVAQ() ? VAQ.txt("Keep your eyes down. Dreadheim doesn’t forgive curiosity.") : "…";
      showDialogue({
        speaker: "Citizen",
        portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
        text: t,
        buttons: [
          { label: "Nod + Move On (Good)", onClick: doGoodCitizen4 },
          { label: "Threaten Him (Evil)", onClick: doEvilCitizen4 },
          { label: "Close", onClick: hideDialogue }
        ]
      });
    }));

    // ESC closes dialogue + pickup
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        hideDialogue();
        pickupHide();
      }
    });

    // DEV hotkeys
    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (e.ctrlKey && e.shiftKey && k === "d"){
        e.preventDefault();
        setDevMode(!document.body.classList.contains("devMode"));
      }
      if (e.ctrlKey && e.shiftKey && k === "c"){
        e.preventDefault();
        copyLayoutToClipboard();
      }
      if (e.ctrlKey && e.shiftKey && k === "r"){
        e.preventDefault();
        resetLayout();
      }
    });

    // start hidden
    hideDialogue();
    pickupHide();
  });

})();
</script>

</body>
</html>








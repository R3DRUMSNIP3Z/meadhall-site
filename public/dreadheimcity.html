```html
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Veriador • Dreadheim • City</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#000;
  font-family:Cinzel, serif;
  overflow:hidden;
}

/* ================= BACKGROUND ================= */
#bg{
  position:fixed;
  inset:0;
  background:url("/guildbook/scenes/dreadheim_city.png") center center / cover no-repeat;
  z-index:0;
}

/* ================= NPCS LAYER ================= */
#npcs{
  position:fixed;
  inset:0;
  z-index:20;
  pointer-events:none; /* allow only NPCs to receive clicks */
}

.npc{
  position:absolute;
  height:auto;
  z-index:25;
  pointer-events:auto;
  cursor:pointer;
  user-select:none;
  -webkit-user-drag:none;
  filter: drop-shadow(0 18px 32px rgba(0,0,0,0.78));
  transition: transform 120ms ease, filter 120ms ease;
}
.npc:hover{
  transform: scale(1.02);
  filter: drop-shadow(0 22px 38px rgba(0,0,0,0.85))
          drop-shadow(0 0 14px rgba(180,200,255,0.22));
}

/* Tweak these positions/sizes however you already had them */
#npcCitizen1{ left:18%; top:55%; width:90px; }
#npcCitizen2{ left:36%; top:58%; width:92px; }
#npcCitizen3{ left:62%; top:54%; width:110px; }
#npcCitizen4{ left:82%; top:56%; width:110px; }

/* ================= DIALOGUE ================= */
#dlg{
  position:fixed;
  left:50%;
  bottom:14px;
  transform:translateX(-50%);
  width:min(1200px, calc(100vw - 24px));
  height:190px;
  z-index:999; /* raised to guarantee clicks */
  display:grid;
  grid-template-columns:240px 1fr;
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(90deg, rgba(35,20,10,.95), rgba(15,10,8,.88));
  border:1px solid rgba(255,208,120,.2);
  box-shadow:0 18px 55px rgba(0,0,0,.6);
}
/* Force dialogue hidden until an NPC opens it */
#dlg.hidden{
  display:none !important;
}

#dlgPortrait{
  width:240px;
  height:190px;
  object-fit:contain;
  align-self:end;
  filter:drop-shadow(0 12px 22px rgba(0,0,0,0.65));
}

#dlgPanel{
  padding:16px 18px;
  display:grid;
  grid-template-rows:auto 1fr auto;
  gap:10px;
}

#dlgName{
  font-size:28px;
  font-weight:900;
  color:rgba(255,225,170,.95);
}

#dlgText{
  font-size:20px;
  line-height:1.35;
  color:rgba(255,255,255,.95);
}

#dlgBtns{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}

#dlg, #dlgPanel, #dlgBtns, .dlgBtn{
  pointer-events:auto;
}

.dlgBtn{
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  border:1px solid rgba(255,208,120,.28);
  background:rgba(120,60,25,.45);
  color:rgba(255,245,230,.95);
  font-weight:800;
}
.dlgBtn:hover{ filter:brightness(1.1); }

/* ================= PICKUP POPUP (RING) ================= */
#pickupOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.72);
  z-index:1000;
  display:none;
}
#pickupCard{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  width:min(520px, calc(100vw - 36px));
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(180deg, rgba(35,20,10,.96), rgba(10,8,8,.92));
  border:1px solid rgba(255,208,120,.22);
  box-shadow:0 24px 80px rgba(0,0,0,.75);
  padding:16px;
}
#pickupRow{
  display:flex;
  gap:14px;
  align-items:center;
}
#pickupImg{
  width:96px;
  height:96px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#pickupImg img{
  width:78px;
  height:78px;
  object-fit:contain;
}
#pickupText{
  flex:1;
  line-height:1.35;
  font-size:18px;
  color:rgba(245,240,230,.95);
}
#pickupBtns{
  margin-top:12px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
</style>
</head>

<body>
<div id="bg"></div>

<div id="npcs">
  <!-- ✅ placeholders fixed to the correct GIFs -->
  <img id="npcCitizen1" class="npc" src="/guildbook/npcs/slaves/blondeman.gif" alt="Street Slave">
  <img id="npcCitizen2" class="npc" src="/guildbook/npcs/slaves/hungrywoman.gif" alt="Hungry Woman">
  <img id="npcCitizen3" class="npc" src="/guildbook/npcs/citizens/helcitizenwoman.gif" alt="Citizen Woman">
  <img id="npcCitizen4" class="npc" src="/guildbook/npcs/citizens/helcitizenman.gif" alt="Citizen Man">
</div>

<!-- Dialogue (HIDDEN until NPC click) -->
<div id="dlg" class="hidden">
  <img id="dlgPortrait" alt="Portrait">
  <div id="dlgPanel">
    <div id="dlgName"></div>
    <div id="dlgText"></div>
    <div id="dlgBtns"></div>
  </div>
</div>

<!-- Ring pickup popup -->
<div id="pickupOverlay" aria-hidden="true">
  <div id="pickupCard" role="dialog" aria-label="Item acquired">
    <div id="pickupRow">
      <div id="pickupImg"><img id="pickupImgInner" alt="Item"></div>
      <div id="pickupText"></div>
    </div>
    <div id="pickupBtns"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ----------------------------
  // Require VAQ (global)
  // ----------------------------
  function ensureVAQ(){
    return !!(window.VAQ && typeof window.VAQ.txt === "function");
  }

  // ----------------------------
  // UI refs
  // ----------------------------
  const dlg = document.getElementById("dlg");
  const dlgName = document.getElementById("dlgName");
  const dlgText = document.getElementById("dlgText");
  const dlgBtns = document.getElementById("dlgBtns");
  const dlgPortrait = document.getElementById("dlgPortrait");

  const pickupOverlay = document.getElementById("pickupOverlay");
  const pickupImgInner = document.getElementById("pickupImgInner");
  const pickupText = document.getElementById("pickupText");
  const pickupBtns = document.getElementById("pickupBtns");

  // ----------------------------
  // Helpers
  // ----------------------------
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function showDialogue({ speaker, text, portraitSrc, buttons = [] }){
    dlgName.textContent = speaker || "";
    dlgText.textContent = (typeof text === "string") ? text : String(text ?? "");
    dlgBtns.innerHTML = "";
    if (portraitSrc) dlgPortrait.src = portraitSrc;
    dlg.classList.remove("hidden");

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = "dlgBtn";
      btn.type = "button";
      btn.textContent = b.label;

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (typeof b.onClick === "function") b.onClick();
      });

      dlgBtns.appendChild(btn);
    });
  }

  function hideDialogue(){
    dlg.classList.add("hidden");
    dlgName.textContent = "";
    dlgText.textContent = "";
    dlgBtns.innerHTML = "";
  }

  function pickupShow({ img, textLines = [], primaryLabel = "Open Inventory", onPrimary, secondaryLabel = "Close", onSecondary }){
    pickupImgInner.src = img || "";
    pickupText.innerHTML = textLines.map(line => `<div>${escapeHtml(line)}</div>`).join("");
    pickupBtns.innerHTML = "";

    const b1 = document.createElement("button");
    b1.className = "dlgBtn";
    b1.type = "button";
    b1.textContent = primaryLabel;
    b1.addEventListener("click", () => {
      pickupHide();
      if (typeof onPrimary === "function") onPrimary();
    });

    const b2 = document.createElement("button");
    b2.className = "dlgBtn";
    b2.type = "button";
    b2.textContent = secondaryLabel;
    b2.addEventListener("click", () => {
      pickupHide();
      if (typeof onSecondary === "function") onSecondary();
    });

    pickupBtns.appendChild(b1);
    pickupBtns.appendChild(b2);

    pickupOverlay.style.display = "block";
    pickupOverlay.setAttribute("aria-hidden","false");
  }

  function pickupHide(){
    pickupOverlay.style.display = "none";
    pickupOverlay.setAttribute("aria-hidden","true");
  }

  pickupOverlay.addEventListener("click", (e) => {
    if (e.target === pickupOverlay) pickupHide();
  });

  // ----------------------------
  // GOOD/EVIL (same overflow rules)
  // ----------------------------
  const GOOD_KEY = "va_good";
  const EVIL_KEY = "va_evil";
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function getNum(key){
    const v = Number(localStorage.getItem(key) || "0");
    return Number.isFinite(v) ? v : 0;
  }
  function setNum(key, n){ localStorage.setItem(key, String(Number(n)||0)); }

  function addAlignment(kind, delta){
    delta = Number(delta) || 0;
    if (!delta) return;

    for (let i = 0; i < Math.abs(delta); i++){
      if (kind === "good"){
        let g = clamp(getNum(GOOD_KEY), 0, 10);
        let e = clamp(getNum(EVIL_KEY), 0, 10);

        if (delta > 0){
          if (g >= 10){
            if (e > 0) e -= 1;
          } else {
            g += 1;
          }
        } else {
          if (g > 0) g -= 1;
        }

        setNum(GOOD_KEY, g);
        setNum(EVIL_KEY, e);
      } else {
        let g = clamp(getNum(GOOD_KEY), 0, 10);
        let e = clamp(getNum(EVIL_KEY), 0, 10);

        if (delta > 0){
          if (e >= 10){
            if (g > 0) g -= 1;
          } else {
            e += 1;
          }
        } else {
          if (e > 0) e -= 1;
        }

        setNum(GOOD_KEY, g);
        setNum(EVIL_KEY, e);
      }
    }

    // refresh global HUD if present
    try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
  }

  // ----------------------------
  // INVENTORY (matches global keys)
  // ----------------------------
  const INV_UNLOCK_KEY = "va_inv_unlocked";
  const INV_ITEMS_KEY  = "va_inv_items";

  function invGetItems(){
    try{
      const arr = JSON.parse(localStorage.getItem(INV_ITEMS_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function invSetItems(items){
    localStorage.setItem(INV_ITEMS_KEY, JSON.stringify(Array.isArray(items) ? items : []));
  }
  function invHasItem(id){
    return invGetItems().some(it => it && it.id === id);
  }
  function invAddItem(item){
    if (!item || !item.id) return;
    if (invHasItem(item.id)) return;
    const items = invGetItems();
    items.push(item);
    invSetItems(items);
  }
  function invUnlock(){
    localStorage.setItem(INV_UNLOCK_KEY, "1");
    try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
  }
  function invOpenViaGlobal(){
    // Global HUD creates invBtn and binds it to open the overlay
    const btn = document.getElementById("invBtn");
    if (btn) btn.click();
  }

  // ----------------------------
  // Actions (GOOD + EVIL per NPC)
  // ----------------------------
  function doGoodCitizen1(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Street Slave",
      portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
      text: VAQ.txt("…You didn’t have to do that. In Dreadheim, kindness is a dangerous habit."),
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen1(){
    addAlignment("evil", 1);
    showDialogue({
      speaker: "Street Slave",
      portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
      text: VAQ.txt("What do you want from me? If it’s not food—leave me alone!?"),
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doGoodCitizen2(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Hungry Woman",
      portraitSrc: "/guildbook/npcs/slaves/hungrywoman.gif",
      text: VAQ.txt("…Thank you. I thought you’d be like the rest of them."),
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doStealRing(){
    // EVIL choice
    addAlignment("evil", 1);

    // Ring item
    const RING_ITEM_ID = "slaves_wedding_ring";
    const RING_ITEM_IMG = "/guildbook/props/slavesring.gif";
    const RING_ITEM_NAME = "Wedding Ring (Slave’s Keepsake)";

    // unlock inv + add item
    invUnlock();
    invAddItem({
      id: RING_ITEM_ID,
      name: RING_ITEM_NAME,
      img: RING_ITEM_IMG
    });

    // popup like amulet, then open inventory
    pickupShow({
      img: RING_ITEM_IMG,
      textLines: [
        "You rummage through her sack that is being used as bottom cover…",
        "and find a special memento the slave cherishes:",
        "her dead husband’s wedding ring."
      ],
      primaryLabel: "Open Inventory",
      onPrimary: () => invOpenViaGlobal(),
      secondaryLabel: "Close",
      onSecondary: () => {}
    });
  }

  function doGoodCitizen3(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
      text: VAQ.txt("…You spared me. That’s rarer than gold in Dreadheim."),
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen3(){
    addAlignment("evil", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
      text: VAQ.txt("You’ve already done enough… leave me be."),
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doGoodCitizen4(){
    addAlignment("good", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
      text: VAQ.txt("Hmph. You chose restraint. Smart—here, mercy costs."),
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  function doEvilCitizen4(){
    addAlignment("evil", 1);
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
      text: VAQ.txt("Keep your eyes down. Dreadheim doesn’t forgive curiosity."),
      buttons: [{ label: "Close", onClick: hideDialogue }]
    });
  }

  // ----------------------------
  // NPC clicks (with 2 options: GOOD + EVIL)
  // ----------------------------
  document.getElementById("npcCitizen1").addEventListener("click", () => {
    if (!ensureVAQ()){
      showDialogue({
        speaker: "Citizen",
        portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
        text: "VAQ missing (global ui not loaded).",
        buttons: [{ label: "Close", onClick: hideDialogue }]
      });
      return;
    }
    showDialogue({
      speaker: "Street Slave",
      portraitSrc: "/guildbook/npcs/slaves/blondeman.gif",
      text: VAQ.txt("What do you want from me, if its not food leave me alone!?"),
      buttons: [
        { label: "Give Food (Good)", onClick: doGoodCitizen1 },
        { label: "Intimidate (Evil)", onClick: doEvilCitizen1 },
        { label: "Close", onClick: hideDialogue }
      ]
    });
  });

  document.getElementById("npcCitizen2").addEventListener("click", () => {
    if (!ensureVAQ()) return;
    showDialogue({
      speaker: "Hungry Woman",
      portraitSrc: "/guildbook/npcs/slaves/hungrywoman.gif",
      text: VAQ.txt("Please… I have nothing worth taking."),
      buttons: [
        { label: "Leave Something (Good)", onClick: doGoodCitizen2 },
        { label: "Steal It (Evil)", onClick: doStealRing },
        { label: "Close", onClick: hideDialogue }
      ]
    });
  });

  document.getElementById("npcCitizen3").addEventListener("click", () => {
    if (!ensureVAQ()) return;
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenwoman.gif",
      text: VAQ.txt("You’ve already done enough… leave me be."),
      buttons: [
        { label: "Spare Her (Good)", onClick: doGoodCitizen3 },
        { label: "Report Back (Cold) (Evil)", onClick: doEvilCitizen3 },
        { label: "Close", onClick: hideDialogue }
      ]
    });
  });

  document.getElementById("npcCitizen4").addEventListener("click", () => {
    if (!ensureVAQ()) return;
    showDialogue({
      speaker: "Citizen",
      portraitSrc: "/guildbook/npcs/citizens/helcitizenman.gif",
      text: VAQ.txt("Keep your eyes down. Dreadheim doesn’t forgive curiosity."),
      buttons: [
        { label: "Nod + Move On (Good)", onClick: doGoodCitizen4 },
        { label: "Threaten Him (Evil)", onClick: doEvilCitizen4 },
        { label: "Close", onClick: hideDialogue }
      ]
    });
  });

  // ESC closes dialogue + pickup
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape"){
      hideDialogue();
      pickupHide();
    }
  });

  // start hidden
  hideDialogue();
});
</script>

<!-- Global UI -->
<script src="/guildbook/js/va_global_ui.js"></script>

</body>
</html>
```






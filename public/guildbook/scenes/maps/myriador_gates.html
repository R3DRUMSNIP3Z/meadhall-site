```html
<!-- /public/guildbook/scenes/maps/myriador_gates.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Veriador â€¢ Myriador â€¢ Front Gates</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#000;
  font-family:Cinzel, serif;
  overflow:hidden;
}

/* ================= BACKGROUND ================= */
#bg{
  position:fixed;
  inset:0;
  background:url("/guildbook/scenes/maps/myriador_gates.png") center center / cover no-repeat;
  z-index:0;
}

/* ================= DEV HINT ================= */
#devHint{
  position:fixed;
  left:14px;
  bottom:14px;
  z-index:999;
  font-size:14px;
  letter-spacing:.03em;
  color:rgba(255,255,255,0.55);
  text-shadow:0 2px 10px rgba(0,0,0,0.8);
  pointer-events:none;
  display:none;
}
body.devMode #devHint{ display:block; }

/* ================= DEV-EDITABLE LAYER ================= */
#props{
  position:fixed;
  inset:0;
  z-index:20;
  pointer-events:none;
}

/* Wrapper that becomes draggable/resizable in DEV */
.devItem{
  position:absolute;
  z-index:25;
  pointer-events:auto;
  user-select:none;
  -webkit-user-drag:none;
  cursor:pointer;
  filter: drop-shadow(0 18px 32px rgba(0,0,0,0.78));
  transition: transform 120ms ease, filter 120ms ease;
}
.devItem:hover{
  transform: scale(1.02);
  filter: drop-shadow(0 22px 38px rgba(0,0,0,0.85))
          drop-shadow(0 0 14px rgba(180,200,255,0.22));
}

/* In DEV mode, show outline + move cursor */
body.devMode .devItem{
  cursor:move;
  outline:1px dashed rgba(255,215,140,.55);
}
.devDragging{
  outline:2px dashed rgba(255,215,140,.88) !important;
  box-shadow:0 0 0 6px rgba(255,215,140,.12) !important;
}


/* NPC image */
.devItem img.npc{
  display:block;
  width:100%;
  height:auto;
  pointer-events:none;
  user-select:none;
  -webkit-user-drag:none;
}

/* resize handles */
.devHandle{
  position:absolute;
  width:14px;
  height:14px;
  border-radius:6px;
  background:rgba(255,215,140,.95);
  border:1px solid rgba(0,0,0,.55);
  display:none;
}
body.devMode .devHandle{ display:block; }
.devHandle.br{ right:-7px; bottom:-7px; cursor:nwse-resize; }
.devHandle.bl{ left:-7px; bottom:-7px; cursor:nesw-resize; }
.devHandle.tr{ right:-7px; top:-7px; cursor:nesw-resize; }
.devHandle.tl{ left:-7px; top:-7px; cursor:nwse-resize; }

/* ================= DIALOGUE ================= */
#dlg{
  position:fixed;
  left:50%;
  bottom:14px;
  transform:translateX(-50%);
  width:min(1200px, calc(100vw - 24px));
  height:190px;
  z-index:999;
  display:grid;
  grid-template-columns:240px 1fr;
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(90deg, rgba(35,20,10,.95), rgba(15,10,8,.88));
  border:1px solid rgba(255,208,120,.2);
  box-shadow:0 18px 55px rgba(0,0,0,.6);
}
#dlg.hidden{ display:none !important; }

#dlgPortrait{
  width:240px;
  height:190px;
  object-fit:contain;
  align-self:end;
  filter:drop-shadow(0 12px 22px rgba(0,0,0,0.65));
}

#dlgPanel{
  padding:16px 18px;
  display:grid;
  grid-template-rows:auto auto 1fr auto;
  gap:10px;
}

#dlgName{
  font-size:28px;
  font-weight:900;
  color:rgba(255,225,170,.95);
}

#dlgMeter{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-start;
}
.meterPill{
  padding:6px 10px;
  border-radius:999px;
  font-size:14px;
  font-weight:900;
  letter-spacing:.04em;
  border:1px solid rgba(255,208,120,.22);
  background:rgba(0,0,0,.30);
  color:rgba(255,240,225,.92);
}
.meterPill.bad{
  border-color:rgba(255,120,120,.25);
}

#dlgText{
  font-size:20px;
  line-height:1.35;
  color:rgba(255,255,255,.95);
  white-space:pre-wrap;
  overflow:auto;
}

#dlgBtns{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
#dlg, #dlgPanel, #dlgBtns, .dlgBtn{ pointer-events:auto; }

.dlgBtn{
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  border:1px solid rgba(255,208,120,.28);
  background:rgba(120,60,25,.45);
  color:rgba(255,245,230,.95);
  font-weight:800;
}
.dlgBtn:hover{ filter:brightness(1.1); }

/* ================= LOCK ================= */
#lockScreen{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.82);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#lockCard{
  width:600px;
  padding:18px;
  border-radius:18px;
  background:linear-gradient(180deg, rgba(35,20,10,.96), rgba(10,8,8,.92));
  border:1px solid rgba(255,208,120,.22);
}
</style>
</head>

<body>

<div id="bg"></div>
<div id="devHint">DEV MODE ON â€” drag NPCs, resize corners, release to save (prints CSS in console). Press M to toggle.</div>

<div id="props">
  <div class="devItem" data-id="gateGuard1" style="left:39.55%; top:43.03%; width:210px; height:auto;">
    <img id="gateGuard1" class="npc" src="/guildbook/npcs/myriador/guard/guard1.gif" alt="Gate Guard 1">
    <div class="devHandle tl"></div><div class="devHandle tr"></div>
    <div class="devHandle bl"></div><div class="devHandle br"></div>
  </div>

  <div class="devItem" data-id="gateGuard2" style="left:49.81%; top:43.07%; width:179.791px; height:auto;">
    <img id="gateGuard2" class="npc" src="/guildbook/npcs/myriador/guard/guard2.gif" alt="Gate Guard 2">
    <div class="devHandle tl"></div><div class="devHandle tr"></div>
    <div class="devHandle bl"></div><div class="devHandle br"></div>
  </div>
</div>

<div id="dlg" class="hidden" aria-hidden="true">
  <img id="dlgPortrait" alt="Portrait">
  <div id="dlgPanel">
    <div id="dlgName"></div>

    <!-- âœ… Meter row -->
    <div id="dlgMeter">
      <div class="meterPill">Convinced: <span id="meterConv">0</span></div>
      <div class="meterPill bad">Not Convinced: <span id="meterNot">0</span></div>
    </div>

    <div id="dlgText"></div>
    <div id="dlgBtns"></div>
  </div>
</div>

<div id="lockScreen">
  <div id="lockCard">
    <div style="font-size:26px;font-weight:900;">Path Locked</div>
    <p>You cannot enter Myriador yet.</p>
    <button class="dlgBtn" id="lockBackBtn">Return</button>
  </div>
</div>

<script src="/guildbook/js/va_global_ui.js"></script>
<script src="/guildbook/js/globalquest.js"></script>

<script>
(() => {
  "use strict";

  const FLAGS_KEY = "va_flags";

  // âœ… Gate page can only be used after this is true
  const REQUIRED_OPEN_FLAG = "unlocked_myriador";

  // âœ… Arrived-at-gates flag (use this to unlock Capital on your Myriador map)
  const ARRIVED_FLAG = "dq_myr_arrived";

  // âœ… This conversation outcome flags (placeholders you can use later)
  const GATE_DONE_FLAG = "dq_myr_gate_spoken_done";
  const GATE_PASS_FLAG = "dq_myr_gate_passed";     // allowed in
  const GATE_FAIL_FLAG = "dq_myr_gate_denied";     // refused

  // âœ… Placeholder "allowed in" destination (change later)
  const MYRIADOR_LAND_URL = "/guildbook/scenes/maps/myriador_land.html";
  // Back to Myriador map
  const MYRIADOR_MAP_URL = "/guildbook/scenes/maps/myriador_map.html";

  // Dialogue UI refs
  const dlg = document.getElementById("dlg");
  const dlgName = document.getElementById("dlgName");
  const dlgText = document.getElementById("dlgText");
  const dlgBtns = document.getElementById("dlgBtns");
  const dlgPortrait = document.getElementById("dlgPortrait");
  const meterConvEl = document.getElementById("meterConv");
  const meterNotEl  = document.getElementById("meterNot");

  function getFlags(){
    try{ return JSON.parse(localStorage.getItem(FLAGS_KEY) || "{}"); }
    catch{ return {}; }
  }
  function setFlags(f){
    localStorage.setItem(FLAGS_KEY, JSON.stringify(f || {}));
  }

  // âœ… Mark arrival at gates on load
  (function markArrived(){
    const f = getFlags();
    if (!f[ARRIVED_FLAG]){
      f[ARRIVED_FLAG] = true;
      setFlags(f);
      try{ window.__va_refresh_icons && window.__va_refresh_icons(); }catch{}
    }
  })();

  // =========================
  // Dialogue helpers
  // =========================
  const meter = { convinced: 0, not: 0 };

  function meterReset(){
    meter.convinced = 0;
    meter.not = 0;
    meterSync();
  }
  function meterSync(){
    meterConvEl.textContent = String(meter.convinced);
    meterNotEl.textContent  = String(meter.not);
  }
  function addConv(n=1){ meter.convinced += (Number(n)||0); meterSync(); }
  function addNot(n=1){ meter.not += (Number(n)||0); meterSync(); }

  function showDialogue({speaker,text,portraitSrc,buttons=[]}){
    dlgName.textContent = speaker || "";
    dlgText.textContent = text || "";
    dlgPortrait.src = portraitSrc || "";
    dlgBtns.innerHTML = "";

    buttons.forEach(b=>{
      const btn=document.createElement("button");
      btn.className="dlgBtn";
      btn.type="button";
      btn.textContent=b.label || "Continue";
      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        if (typeof b.onClick === "function") b.onClick();
      });
      dlgBtns.appendChild(btn);
    });

    dlg.classList.remove("hidden");
    dlg.setAttribute("aria-hidden","false");
  }

  function hideDialogue(){
    dlg.classList.add("hidden");
    dlg.setAttribute("aria-hidden","true");
    dlgName.textContent = "";
    dlgText.textContent = "";
    dlgBtns.innerHTML = "";
  }

  // =========================
  // DEV: DRAG + RESIZE (matches your Dreadheim City)
  // =========================
  const DEV_KEY = "va_scene_dev";
  const POS_KEY = "va_scene_positions_" + location.pathname;

  let devMode = localStorage.getItem(DEV_KEY) === "1";
  document.body.classList.toggle("devMode", devMode);

  const items = [...document.querySelectorAll("#props .devItem")];

  function getSaved(){
    try{ return JSON.parse(localStorage.getItem(POS_KEY) || "{}"); }
    catch{ return {}; }
  }
  function saveAll(obj){
    localStorage.setItem(POS_KEY, JSON.stringify(obj || {}));
  }
  function applySaved(){
    const s = getSaved();
    items.forEach(el => {
      const id = el.dataset.id;
      const v = s[id];
      if (!v) return;
      if (v.left) el.style.left = v.left;
      if (v.top) el.style.top = v.top;
      if (v.width) el.style.width = v.width;
      if (v.height && v.height !== "auto") el.style.height = v.height;
    });
  }
  applySaved();

  function pctX(px){ return (px / window.innerWidth * 100).toFixed(2) + "%"; }
  function pctY(py){ return (py / window.innerHeight * 100).toFixed(2) + "%"; }

  let active = null;
  let mode = null; // "drag" | "resize"
  let handle = "br";
  let sx=0, sy=0, sl=0, st=0, sw=0;

  function onMouseMove(e){
    if (!devMode || !active) return;

    if (mode === "drag"){
      const nl = sl + (e.clientX - sx);
      const nt = st + (e.clientY - sy);
      active.style.left = pctX(nl);
      active.style.top  = pctY(nt);
      return;
    }

    // resize width only (keeps sprite aspect)
    const dx = e.clientX - sx;
    let newW = sw;

    if (handle === "br" || handle === "tr") newW = sw + dx;
    if (handle === "bl" || handle === "tl") newW = sw - dx;

    newW = Math.max(24, newW);
    active.style.width = newW + "px";

    // if resizing from left corners, keep corner pinned
    if (handle === "bl" || handle === "tl"){
      const nl = sl + dx;
      active.style.left = pctX(nl);
    }
  }

  function onMouseUp(){
    if (!active) return;

    active.classList.remove("devDragging");

    // save
    const all = getSaved();
    all[active.dataset.id] = {
      left: active.style.left,
      top: active.style.top,
      width: active.style.width,
      height: active.style.height || "auto"
    };
    saveAll(all);

    // print CSS line (like your other pages)
    console.log(
      `/* ${active.dataset.id} */`,
      `left:${active.style.left}; top:${active.style.top}; width:${active.style.width};`
    );

    active = null;
    mode = null;
  }

  items.forEach(el => {
    // drag on wrapper (ignore handles)
    el.addEventListener("mousedown", (e) => {
      if (!devMode) return;
      if (e.target && e.target.classList && e.target.classList.contains("devHandle")) return;

      const r = el.getBoundingClientRect();
      active = el;
      mode = "drag";
      sx = e.clientX; sy = e.clientY;
      sl = r.left;   st = r.top;

      el.classList.add("devDragging");
      e.preventDefault();
      e.stopPropagation();
    });

    // resize handles
    el.querySelectorAll(".devHandle").forEach(h => {
      h.addEventListener("mousedown", (e) => {
        if (!devMode) return;

        const r = el.getBoundingClientRect();
        active = el;
        mode = "resize";
        handle = [...h.classList].find(c => ["tl","tr","bl","br"].includes(c)) || "br";

        sx = e.clientX; sy = e.clientY;
        sl = r.left;   st = r.top;
        sw = r.width;

        el.classList.add("devDragging");
        e.preventDefault();
        e.stopPropagation();
      });
    });
  });

  window.addEventListener("mousemove", onMouseMove);
  window.addEventListener("mouseup", onMouseUp);

  // toggle dev mode with M
  window.addEventListener("keydown", (e) => {
    if (e.key && e.key.toLowerCase() === "m"){
      devMode = !devMode;
      localStorage.setItem(DEV_KEY, devMode ? "1" : "0");
      document.body.classList.toggle("devMode", devMode);
      console.log(devMode ? "ðŸ›  DEV MODE ON" : "ðŸ§­ DEV MODE OFF");
    }
    if (e.key === "Escape"){
      hideDialogue();
    }
  });

  // =========================
  // Gate lock overlay
  // =========================
  const f0 = getFlags();
  if(!f0[REQUIRED_OPEN_FLAG]){
    document.getElementById("lockScreen").style.display="flex";
    document.getElementById("lockBackBtn").onclick=()=>location.href=MYRIADOR_MAP_URL;
  }

  // =========================
  // REAL GATE DIALOGUE FLOW (local, placeholder-friendly)
  // - Covers your story: escaped Helheim, hunted by Helâ€™s thugs
  // - Choices increment meter: convinced / not convinced
  // - End resolves: pass if convinced > not
  // =========================
  function gateEnd(){
    const f = getFlags();
    f[GATE_DONE_FLAG] = true;

    if (meter.convinced > meter.not){
      f[GATE_PASS_FLAG] = true;
      delete f[GATE_FAIL_FLAG];
      setFlags(f);

      showDialogue({
        speaker: "Myriador Guard Captain",
        portraitSrc: "/guildbook/npcs/myriador/guard/guard.gif",
        text:
`Very well.
Your tale reeks of Helheimâ€¦ yet your eyes do not.
We grant you passage â€” on a short leash.

(Placeholder: you are allowed into Myriador.)`,
        buttons: [
          { label:"Enter Myriador", onClick:()=>location.href=MYRIADOR_LAND_URL },
          { label:"Back to Map", onClick:()=>location.href=MYRIADOR_MAP_URL }
        ]
      });
      return;
    }

    f[GATE_FAIL_FLAG] = true;
    delete f[GATE_PASS_FLAG];
    setFlags(f);

    showDialogue({
      speaker: "Myriador Guard Captain",
      portraitSrc: "/guildbook/npcs/myriador/guard/guard.gif",
      text:
`No.
We will not invite Helâ€™s shadow behind our walls.

Find another way in â€” or bring proof that Myriador can trust you.
(Placeholder: denied.)`,
      buttons: [
        { label:"Leave", onClick:()=>location.href=MYRIADOR_MAP_URL },
        { label:"Close", onClick:hideDialogue }
      ]
    });
  }

  function startGateTalk(){
    meterReset();

    showDialogue({
      speaker: "Myriador Guard Captain",
      portraitSrc: "/guildbook/npcs/myriador/guard/guard.gif",
      text:
`Hold.
State your name â€” and your business at the gates of Myriador.

You bear the stink of Helheim on your clothesâ€¦`,
      buttons: [
        {
          label:"Tell the truth: â€˜I escaped Helâ€™s thugsâ€™",
          onClick: () => {
            addConv(1);
            showDialogue({
              speaker:"Myriador Guard Captain",
              portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
              text:
`Escaped Helheimâ€¦?
Many say that when they want our pity.

Why should Myriador shelter you?`,
              buttons:[
                {
                  label:"â€˜I seek refuge â€” and Iâ€™ll serve Myriador.â€™",
                  onClick: () => {
                    addConv(1);
                    showDialogue({
                      speaker:"Myriador Guard Captain",
                      portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
                      text:
`Service is cheap. Loyalty is rare.
What can you offer that isnâ€™t a lie?`,
                      buttons:[
                        {
                          label:"Offer oath + vow to expose Helâ€™s agents",
                          onClick: () => {
                            addConv(1);
                            showDialogue({
                              speaker:"Myriador Guard Captain",
                              portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
                              text:
`An oathâ€¦
Helâ€™s spies love oaths â€” until the knife comes out.

Prove youâ€™re not one of them.`,
                              buttons:[
                                {
                                  label:"Show wounds / signs of captivity (placeholder)",
                                  onClick: () => {
                                    addConv(1);
                                    showDialogue({
                                      speaker:"Myriador Guard Captain",
                                      portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
                                      text:
`Hmph.
Those marksâ€¦ are not self-made.

One last question.`,
                                      buttons:[
                                        {
                                          label:"Answer calmly: â€˜I want to do good here.â€™",
                                          onClick: () => { addConv(1); gateEnd(); }
                                        },
                                        {
                                          label:"Get angry: â€˜Let me in or regret it.â€™",
                                          onClick: () => { addNot(2); gateEnd(); }
                                        }
                                      ]
                                    });
                                  }
                                },
                                {
                                  label:"Refuse to show anything",
                                  onClick: () => { addNot(2); gateEnd(); }
                                }
                              ]
                            });
                          }
                        },
                        {
                          label:"Try to bribe the guards",
                          onClick: () => { addNot(2); gateEnd(); }
                        }
                      ]
                    });
                  }
                },
                {
                  label:"Lie: â€˜Iâ€™m a merchant on royal business.â€™",
                  onClick: () => {
                    addNot(1);
                    showDialogue({
                      speaker:"Myriador Guard Captain",
                      portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
                      text:
`A merchant? With no seal. No caravan. No escort.
Try again.`,
                      buttons:[
                        { label:"Admit truth: â€˜Fineâ€”Helâ€™s thugs hunted me.â€™", onClick:()=>{ addConv(1); gateEnd(); } },
                        { label:"Double down on the lie", onClick:()=>{ addNot(2); gateEnd(); } }
                      ]
                    });
                  }
                }
              ]
            });
          }
        },
        {
          label:"Hide details: â€˜I just need entry.â€™",
          onClick: () => {
            addNot(1);
            showDialogue({
              speaker:"Myriador Guard Captain",
              portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
              text:
`Then youâ€™ll get none.
Myriador is not a gutter for strangers.`,
              buttons:[
                { label:"Explain: â€˜Helâ€™s minions will kill me if you refuse.â€™", onClick:()=>{ addConv(1); gateEnd(); } },
                { label:"Threaten them", onClick:()=>{ addNot(2); gateEnd(); } }
              ]
            });
          }
        },
        { label:"Leave", onClick:()=>location.href=MYRIADOR_MAP_URL }
      ]
    });
  }

  // =========================
  // Click wiring (FIXED)
  // - bind both guards
  // - block while devMode
  // =========================
  function bindGuardClicks(){
    const g1 = document.querySelector('[data-id="gateGuard1"]');
    const g2 = document.querySelector('[data-id="gateGuard2"]');

    if (g1){
      g1.addEventListener("click", (e) => {
        if (devMode) return;
        e.preventDefault(); e.stopPropagation();

        const f = getFlags();
        if (f[GATE_DONE_FLAG]){
          showDialogue({
            speaker:"Myriador Guard",
            portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
            text:"Move along. The Captain has already decided your fate.",
            buttons:[
              { label:"Back to Map", onClick:()=>location.href=MYRIADOR_MAP_URL },
              { label:"Close", onClick:hideDialogue }
            ]
          });
          return;
        }

        startGateTalk();
      });
    }

    if (g2){
      g2.addEventListener("click", (e) => {
        if (devMode) return;
        e.preventDefault(); e.stopPropagation();
        // same behavior as guard1
        if (getFlags()[GATE_DONE_FLAG]){
          showDialogue({
            speaker:"Myriador Guard",
            portraitSrc:"/guildbook/npcs/myriador/guard/guard.gif",
            text:"The Captain already gave the order. Keep moving.",
            buttons:[
              { label:"Back to Map", onClick:()=>location.href=MYRIADOR_MAP_URL },
              { label:"Close", onClick:hideDialogue }
            ]
          });
          return;
        }
        startGateTalk();
      });
    }
  }

  bindGuardClicks();

})();
</script>

</body>
</html>
```



<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mead Hall â€¢ Library</title>

  <!-- Brand / Fonts / Odin -->
  <link rel="icon" type="image/png" href="/logo/favicon.ico.png">
  <link rel="apple-touch-icon" href="/logo/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cinzel+Decorative:wght@400;700&family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/Styles/odin.css"/>

  <style>
  :root{
    --bg:#0b0e10; --panel:#151515d0; --border:#3b3325; --ink:#e9e4d5; --gold:#d4a94d; --gold-soft:#aa8a28;
  }
  *{box-sizing:border-box}
  body{background:var(--bg); color:var(--ink); font-family:"Cinzel",serif; margin:0; min-height:100svh; display:flex; flex-direction:column}

  /* Header */
  header.site-header{position:sticky; top:0; z-index:50; background:var(--panel); border-bottom:1px solid var(--border)}
  header .wrap{display:flex; align-items:center; gap:16px; padding:.6rem 1rem; width:min(1200px, 94vw); margin:0 auto}
  header h1{font-size:1.1rem; margin:0}
  nav{margin-left:auto; display:flex; gap:16px; align-items:center}
  nav a{color:var(--ink); text-decoration:none; font-size:.95rem}
  nav a:hover{color:#ffd700}

  /* Coins UI (with hover zoom) */
  .coinbox{
    position:relative;
    display:flex; align-items:center; gap:6px;
    padding:4px 10px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#0f1113;
    color:#ffd700;
    font-weight:900;
    line-height:1;
    user-select:none;
  }
  .coinbox img{width:18px; height:18px; object-fit:contain; display:block}
  .coinbox #coinCount{min-width:18px; text-align:right}

  .coinbox .coinZoom{
    position:absolute;
    top:115%;
    right:0;
    width:220px;
    height:220px;
    background:#0f1113;
    border:1px solid var(--border);
    border-radius:14px;
    box-shadow:0 16px 40px rgba(0,0,0,.6);
    padding:10px;
    z-index:999;

    opacity:0;
    transform:translateY(-6px);
    pointer-events:none;
    transition:opacity .15s ease, transform .15s ease;
  }
  .coinbox .coinZoom img{
    width:100%;
    height:100%;
    object-fit:contain;
    border-radius:10px;
  }
  .coinbox:hover .coinZoom{
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
  }

  .title{
    padding:1rem; text-align:center; font-size:1.8rem; font-weight:800; color:#ffd700;
    text-shadow:0 0 5px #d4a94d,0 0 10px #ffcc00,0 0 15px #ffea80;
    border-bottom:2px solid var(--border);
  }

  /* Toolbar */
  .toolbar{display:flex; gap:10px; align-items:center; padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--border); flex-wrap:wrap}
  .toolbar .wrap{width:min(1200px,94vw); margin:0 auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .search{
    flex:1; min-width:240px; display:flex; align-items:center; gap:8px; background:#0f1113; border:1px solid var(--border); border-radius:10px; padding:8px 10px;
  }
  .search input{flex:1; background:transparent; border:0; outline:none; color:var(--ink); font-size:1rem}
  .btn, .link{
    background:var(--gold); color:#0b0e10; border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; text-decoration:none;
    border:1px solid var(--border);
  }
  .btn.secondary{ background:transparent; color:var(--ink); }
  .btn:hover,.link:hover{ filter:brightness(1.05) }

  /* Chips */
  .chips{padding:10px 14px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01))}
  .chips .wrap{width:min(1200px,94vw); margin:0 auto; display:flex; gap:8px; flex-wrap:wrap}
  .chip{
    padding:6px 12px; border:1px solid var(--border); border-radius:999px; cursor:pointer; white-space:nowrap; background:#0f1113; color:#e9e4d5; font-size:.9rem;
  }
  .chip.active{ background:var(--gold); color:#0b0e10; border-color:var(--gold); }

  /* Grid */
  main .wrap{width:min(1200px,94vw); margin:14px auto; flex:1}
  .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr))}
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-height:220px;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }
  .cover{height:150px; background:#0f1113; display:flex; align-items:center; justify-content:center; border-bottom:1px solid var(--border)}
  .cover img{max-height:100%; max-width:100%; object-fit:cover}
  .card .head{padding:12px 12px 0}
  .card h3{margin:0; font-size:1.05rem; color:#ffd700}
  .meta{opacity:.9; font-size:.9rem; color:var(--gold-soft); margin-top:2px}
  .summary{padding:10px 12px; color:#e9e4d5; opacity:.95}
  .tagrow{display:flex; gap:6px; flex-wrap:wrap; padding:0 12px 10px}
  .t{font-size:.78rem; border:1px solid var(--border); padding:3px 8px; border-radius:999px; background:#0f1113; color:#c8c1aa}
  .actions{margin-top:auto; display:flex; gap:8px; padding:10px 12px; border-top:1px solid var(--border)}
  .actions .btn{flex:1; text-align:center; font-weight:800; padding:8px 10px; border-radius:10px; cursor:pointer; background:#0f1113; color:var(--ink)}
  .actions .btn.primary{background:var(--gold); color:#0b0e10}
  .empty{opacity:.8; text-align:center; padding:26px}

  /* Pager */
  .pager{display:flex; justify-content:center; gap:8px; padding:14px}
  .pager .btn{padding:8px 12px}
</style>

</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="wrap">
      <a href="/" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit">
        <img src="/logo/logo-64.png" alt="Mead Hall" style="width:32px;height:32px;border-radius:6px;object-fit:cover"/>
        <h1>Mead Hall</h1>
      </a>

      <nav>
        <a href="/index.html#plans">Membership</a>
        <a href="/index.html#contest">Skald Contest</a>
        <a href="/index.html#lore">Lore</a>
        <a href="/account.html">Account</a>
        <a href="/library.html" aria-label="Open the Library" style="color:#ffd700">Library</a>

        <!-- Coins + Achievements -->
<div class="coinbox" title="Coins earned from interactive stories">
  <img src="/icons/coins.png" alt="Coins">
  <span id="coinCount">0</span>

  <!-- Hover zoom preview -->
  <div class="coinZoom" aria-hidden="true">
    <img src="/icons/coins.png" alt="">
  </div>
</div>

</nav>
    </div>
  </header>
  <div class="title">ðŸ“š Mead Hall â€¢ Library</div>

  <!-- Toolbar -->
  <section class="toolbar">
    <div class="wrap">
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79L20 21.5 21.5 20zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5"/></svg>
        <input id="q" type="text" placeholder="Search title, author, or tag..."/>
      </div>
    </div>
  </section>

  <!-- Tag chips -->
  <div class="chips"><div class="wrap" id="chips"></div></div>

  <!-- Grid -->
  <main>
    <div class="wrap">
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="pager" class="pager" hidden>
        <button id="prev" class="btn secondary">â€¹ Prev</button>
        <div id="pageinfo" style="align-self:center"></div>
        <button id="next" class="btn secondary">Next â€º</button>
      </div>
    </div>
  </main>

  <script type="module">
    // ===== Coins display (new) =====
    const COIN_KEY = 'mh_coins';
    function getCoins(){
      return parseInt(localStorage.getItem(COIN_KEY) || '0', 10);
    }
    function renderCoins(){
      const el = document.getElementById('coinCount');
      if(!el) return;
      el.textContent = String(getCoins());
    }
    renderCoins();
    // Optional: if you later dispatch an event when coins change, this will update live.
    window.addEventListener('mh_coins_changed', renderCoins);

    // --- Config: where to open a story ---
    // Books (rtf/txt/html) open book.html
    // Interactive (json) opens story.html when item.type === "interactive"
    function readerUrl(item){
      const isInteractive = (item.type || 'book') === 'interactive';
      if (isInteractive) {
        const u = new URL('/story.html', location.origin);
        u.searchParams.set('src', item.src);
        u.searchParams.set('title', item.title || '');
        if (item.cover) u.searchParams.set('cover', item.cover);
        return u.pathname + u.search;
      }

      const u = new URL('/book.html', location.origin);
      u.searchParams.set('src', item.src);      // RTF / HTML / TXT under /guildbook/
      u.searchParams.set('title', item.title || '');  // for the chrome bar
      if (item.cover) u.searchParams.set('cover', item.cover);
      return u.pathname + u.search;
    }

    // --- Catalog loader ---
    // Tries /guildbook/catalog.json, else falls back to inline items.
    async function loadCatalog(){
      try{
        const r = await fetch('/guildbook/catalog.json', {cache:'no-store'});
        if(!r.ok) throw 0;
        const js = await r.json();
        if(!Array.isArray(js)) throw 0;
        return js;
      }catch{
        // Fallback sample(s) â€” add more here or move them into catalog.json
        return [
          {
            id: 'thorvald',
            title: 'Thorvald Eiriksson',
            author: 'Lisa',
            tags: ['Viking','Greenland','Saga'],
            summary: 'A windswept morning above BrattahlÃ­Ã°. Blood in the courtyard, slavers on the road, and a choice that will echo across the fjords.',
            type: 'book',
            src: '/guildbook/samplestorythorvald.rtf',
            cover: '/guildbook/thorvald-cover.jpg'
          },
          {
            id: 'vikingstory',
            title: 'Viking Story Placeholder Name',
            author: 'Lisa',
            tags: ['Interactive','Viking'],
            summary: 'An interactive test story.',
            type: 'interactive',
            src: '/guildbook/vikingstory.json',
            cover: '/guildbook/vikingstory-cover.jpg'
          }
        ];
      }
    }

    // --- Progress helpers (matches book.ts) ---
    function getBookProgressKeyFromSrc(src){
      let path = src;
      try { path = new URL(src, location.origin).pathname; } catch {}
      path = (path.startsWith('/') ? path : '/' + path).toLowerCase();
      return 'mh_book_progress:' + encodeURIComponent(path);
    }
    function getStoryProgressKeyFromSrc(src){
      let path = src;
      try { path = new URL(src, location.origin).pathname; } catch {}
      path = (path.startsWith('/') ? path : '/' + path).toLowerCase();
      return 'mh_story_progress:' + encodeURIComponent(path);
    }

    function getContinueData(items){
      // Prefer "last opened" (book or story)
      const lastBook = localStorage.getItem('mh_last_book') || '';
      const lastStory = localStorage.getItem('mh_last_story_src') || '';

      const candidates = [];

      if (lastBook) candidates.push({ kind: 'book', src: lastBook });
      if (lastStory) candidates.push({ kind: 'interactive', src: lastStory });

      for (const c of candidates) {
        try{
          const lastPath = new URL(c.src, location.origin).pathname.toLowerCase();
          const match = items.find(it => {
            const s = it?.src || '';
            if(!s) return false;
            try { return new URL(s, location.origin).pathname.toLowerCase() === lastPath; } catch { return s === c.src; }
          });
          if(match){
            if ((match.type || 'book') === 'interactive') {
              const key = getStoryProgressKeyFromSrc(match.src);
              const node = localStorage.getItem(key) || match?.start || 'start';
              const updated = localStorage.getItem(key + ':updated') || '';
              return { item: match, kind: 'interactive', label: node, updated };
            } else {
              const key = getBookProgressKeyFromSrc(match.src);
              const page = parseInt(localStorage.getItem(key) || '0', 10) + 1;
              const updated = localStorage.getItem(key + ':updated') || '';
              return { item: match, kind: 'book', label: `Page ${Math.max(1, page)}`, updated };
            }
          }
        }catch{}
      }

      // Fallback: most recently updated progress among all items
      let best = null;

      for(const it of items){
        if(!it?.src) continue;

        const isInteractive = (it.type || 'book') === 'interactive';
        const key = isInteractive ? getStoryProgressKeyFromSrc(it.src) : getBookProgressKeyFromSrc(it.src);
        const updated = localStorage.getItem(key + ':updated');
        if(!updated) continue;

        if(!best || updated > best.updated){
          if (isInteractive) {
            const node = localStorage.getItem(key) || 'start';
            best = { item: it, kind: 'interactive', label: node, updated };
          } else {
            const page = parseInt(localStorage.getItem(key) || '0', 10) + 1;
            best = { item: it, kind: 'book', label: `Page ${Math.max(1, page)}`, updated };
          }
        }
      }

      return best;
    }

    function niceWhen(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d.getTime())) return '';
      return d.toLocaleString(undefined, { month:'short', day:'numeric', year:'numeric' });
    }

    // --- State ---
    const state = {
      all: [],
      query: '',
      tag: 'All',
      page: 1,
      perPage: 12
    };

    // --- Elements --
    const grid = document.getElementById('grid');
    const q = document.getElementById('q');
    const chips = document.getElementById('chips');
    const pager = document.getElementById('pager');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const pageinfo = document.getElementById('pageinfo');

    // --- Helpers ---
    function uniqTags(items){
      const set = new Set();
      items.forEach(it => (it.tags||[]).forEach(t=>set.add(String(t))));
      return ['All', ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
    }
    function matches(it){
      const qv = state.query.trim().toLowerCase();
      const tag = state.tag;
      if(tag !== 'All' && !(it.tags||[]).map(String).includes(tag)) return false;
      if(!qv) return true;
      const hay = [
        it.title||'',
        it.author||'',
        (it.tags||[]).join(' '),
        it.summary||''
      ].join(' â€¢ ').toLowerCase();
      return hay.includes(qv);
    }
    function paginate(list){
      const start = (state.page-1)*state.perPage;
      return list.slice(start, start + state.perPage);
    }

    function renderChips(list){
      chips.innerHTML = '';
      list.forEach(t=>{
        const b = document.createElement('button');
        b.className = 'chip' + (t===state.tag?' active':'');
        b.textContent = t;
        b.onclick = ()=>{ state.tag=t; state.page=1; draw(); };
        chips.appendChild(b);
      });
    }

    function card(item) {
      const el = document.createElement('article');
      el.className = 'card';
      const cover = item.cover
        ? `<img src="${item.cover}" alt="">`
        : `<div style="color:#aa8a28">ðŸ“– Mead Hall</div>`;
      const tags = (item.tags || []).map(t => `<span class="t">${t}</span>`).join('');
      const readHref = readerUrl(item);

      el.innerHTML = `
        <div class="cover">${cover}</div>
        <div class="head">
          <h3>${item.title || 'Untitled'}</h3>
          <div class="meta">${item.author ? 'by ' + item.author : ''}</div>
        </div>
        <div class="summary">${item.summary || ''}</div>
        <div class="tagrow">${tags}</div>
        <div class="actions">
          <a class="btn primary" href="${readHref}">Read</a>
        </div>
      `;
      return el;
    }

    function continueCard(data){
      const { item, label, updated, kind } = data;
      const el = document.createElement('article');
      el.className = 'card';
      el.style.borderColor = '#d4a94d';
      el.style.boxShadow = '0 10px 26px rgba(0,0,0,.45)';

      const cover = item.cover
        ? `<img src="${item.cover}" alt="">`
        : `<div style="color:#aa8a28">ðŸ“– Mead Hall</div>`;

      const tags = (item.tags || []).map(t => `<span class="t">${t}</span>`).join('');
      const readHref = readerUrl(item);

      el.innerHTML = `
        <div class="cover">${cover}</div>
        <div class="head">
          <h3>Continue ${kind === 'interactive' ? 'Story' : 'Reading'}</h3>
          <div class="meta">${item.title ? item.title : ''}${item.author ? ` â€¢ by ${item.author}` : ''}</div>
        </div>
        <div class="summary">
          Last: <b>${label}</b>
          ${updated ? `<div style="margin-top:6px;opacity:.85;font-size:.9rem">Updated: ${niceWhen(updated)}</div>` : ''}
        </div>
        <div class="tagrow">${tags}</div>
        <div class="actions">
          <a class="btn primary" href="${readHref}">Resume</a>
        </div>
      `;
      return el;
    }

    function draw(){
      const filtered = state.all.filter(matches);
      const totalPages = Math.max(1, Math.ceil(filtered.length / state.perPage));
      if(state.page > totalPages) state.page = totalPages;

      grid.innerHTML = '';

      // Continue Reading/Story appears only when it makes sense (no filters)
      if(state.tag === 'All' && !state.query.trim()){
        const cont = getContinueData(state.all);
        if(cont){
          grid.appendChild(continueCard(cont));
        }
      }

      if(!filtered.length){
        grid.innerHTML += `<div class="card empty">No stories match your filters.</div>`;
      }else{
        paginate(filtered).forEach(it => grid.appendChild(card(it)));
      }

      // pager
      pager.hidden = totalPages <= 1;
      pageinfo.textContent = `${state.page} / ${totalPages}`;
      prev.disabled = state.page<=1;
      next.disabled = state.page>=totalPages;
    }

    // --- Events ---
    q.addEventListener('input', ()=>{
      state.query = q.value;
      state.page = 1;
      draw();
    });
    prev.addEventListener('click', ()=>{ if(state.page>1){ state.page--; draw(); } });
    next.addEventListener('click', ()=>{ state.page++; draw(); });

    // --- Boot ---
    (async ()=>{
      state.all = await loadCatalog();

      // Build chips from tags
      renderChips(uniqTags(state.all));

      // Optional: accept ?q= and ?tag= in URL
      const params = new URLSearchParams(location.search);
      const qParam = params.get('q'); const tagParam = params.get('tag');
      if(qParam){ q.value = qParam; state.query = qParam; }
      if(tagParam){ state.tag = tagParam; }

      draw();
    })();
  </script>
</body>
</html>




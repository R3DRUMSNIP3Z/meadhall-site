<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Veriador • Dreadheim • Mead Hall</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
html, body{
  margin:0; padding:0;
  width:100%; height:100%;
  background:#000;
  font-family:Cinzel, serif;
  overflow:hidden;
}

/* ================= BACKGROUND ================= */
#bg{
  position:fixed;
  inset:0;
  background:url("/guildbook/scenes/dreadheim_meadhall_empty.png") center center / cover no-repeat;
  z-index:0;
}

/* ================= NPC LAYER ================= */
#npcLayer{
  position:fixed;
  inset:0;
  z-index:5;
  pointer-events:none; /* children will re-enable */
}

/* Clickable NPC image */
.npc{
  position:absolute;
  width:180px;
  height:auto;
  pointer-events:auto;
  cursor:pointer;
  user-select:none;
  -webkit-user-drag:none;

  filter: drop-shadow(0 18px 32px rgba(0,0,0,0.75));
  transition: transform 120ms ease, filter 120ms ease;
  opacity:0.98;
}

.npc:hover{
  transform: scale(1.02);
  filter: drop-shadow(0 20px 40px rgba(0,0,0,0.85));
}

/* Optional small “talk” hint */
.npcHint{
  position:absolute;
  left:50%;
  top:-18px;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.55);
  border:1px solid rgba(255,215,140,0.25);
  padding:4px 8px;
  border-radius:10px;
  font-size:12px;
  letter-spacing:0.06em;
  color:rgba(255,235,200,0.92);
  pointer-events:none;
  opacity:0;
  transition: opacity 140ms ease;
  white-space:nowrap;
}

.npcWrap:hover .npcHint{ opacity:1; }

/* ================= DIALOGUE (HIDDEN UNTIL CLICK) ================= */
#dlg{
  position:fixed;
  left:50%;
  bottom:14px;
  transform:translateX(-50%);
  width:min(1200px, calc(100vw - 24px));
  height:190px;
  z-index:20;
  display:grid;
  grid-template-columns:240px 1fr;
  border-radius:18px;
  overflow:hidden;
  background:linear-gradient(90deg, rgba(35,20,10,.95), rgba(15,10,8,.88));
  border:1px solid rgba(255,208,120,.2);
  box-shadow:0 18px 55px rgba(0,0,0,.6);
}

.hidden{ display:none; }

#dlgPortrait{
  width:240px;
  height:190px;
  object-fit:contain;
  align-self:end;
  filter:drop-shadow(0 12px 22px rgba(0,0,0,0.65));
}

#dlgPanel{
  padding:16px 18px;
  display:grid;
  grid-template-rows:auto 1fr auto;
  gap:10px;
}

#dlgName{
  font-size:28px;
  font-weight:900;
  color:rgba(255,225,170,.95);
}

#dlgText{
  font-size:20px;
  line-height:1.35;
  color:rgba(255,255,255,.95);
}

#dlgBtns{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.dlgBtn{
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  border:1px solid rgba(255,208,120,.28);
  background:rgba(120,60,25,.45);
  color:rgba(255,245,230,.95);
  font-weight:800;
}

.dlgBtn:hover{ filter:brightness(1.08); }

.dlgBtn.secondary{
  background:rgba(0,0,0,.25);
}

/* ================= CLICK-BLOCK OVERLAY (optional) ================= */
#tapBlock{
  position:fixed;
  inset:0;
  z-index:15;
  display:none; /* only used if you want to prevent clicking NPCs during dialogue */
}
</style>
</head>

<body>
<div id="bg"></div>

<!-- NPCs -->
<div id="npcLayer">

  <!-- Hel wrapper (adjust left/top later to place her) -->
  <div class="npcWrap" style="position:absolute; left:72%; top:34%;">
    <div class="npcHint">TALK</div>
    <img
      id="npcHel"
      class="npc"
      src="/guildbook/npcs/hel/frame_008.png"
      alt="Hel"
      data-catalog="/data/episodes/volume1_ep1/hel_dialogue.json"
      data-speaker="Hel"
      data-portrait="/guildbook/npcs/hel/frame_008.png"
    />
  </div>

</div>

<!-- Dialogue UI (hidden until NPC click) -->
<div id="dlg" class="hidden">
  <img id="dlgPortrait" alt="Portrait">
  <div id="dlgPanel">
    <div id="dlgName"></div>
    <div id="dlgText"></div>
    <div id="dlgBtns">
      <button id="dlgClose" class="dlgBtn secondary" type="button">Close</button>
      <button id="dlgNext" class="dlgBtn" type="button">Continue</button>
    </div>
  </div>
</div>

<div id="tapBlock"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // UI refs
  const dlg = document.getElementById("dlg");
  const dlgName = document.getElementById("dlgName");
  const dlgText = document.getElementById("dlgText");
  const dlgPortrait = document.getElementById("dlgPortrait");
  const dlgNext = document.getElementById("dlgNext");
  const dlgClose = document.getElementById("dlgClose");
  const tapBlock = document.getElementById("tapBlock");

  // State
  let activeLines = [];
  let activeIdx = 0;

  function safeText(v){
    if (Array.isArray(v)) return v.filter(Boolean).join(" ");
    if (typeof v === "string") return v;
    if (v == null) return "";
    return String(v);
  }

  async function loadJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load " + url + " (" + res.status + ")");
    return await res.json();
  }

  function openDialogue({ speaker, portraitSrc, lines }){
    activeLines = Array.isArray(lines) ? lines : [];
    activeIdx = 0;

    dlgName.textContent = speaker || "…";
    dlgPortrait.src = portraitSrc || "";
    dlgText.textContent = safeText(activeLines[0] || "");

    dlg.classList.remove("hidden");
    tapBlock.style.display = "block"; // optional: prevents clicking NPCs while reading
    updateButtons();
  }

  function closeDialogue(){
    dlg.classList.add("hidden");
    tapBlock.style.display = "none";
    activeLines = [];
    activeIdx = 0;
  }

  function updateButtons(){
    const isLast = activeIdx >= (activeLines.length - 1);
    dlgNext.textContent = isLast ? "Done" : "Continue";
  }

  function nextLine(){
    if (!activeLines.length){
      closeDialogue();
      return;
    }
    const isLast = activeIdx >= (activeLines.length - 1);
    if (isLast){
      closeDialogue();
      return;
    }
    activeIdx += 1;
    dlgText.textContent = safeText(activeLines[activeIdx] || "");
    updateButtons();
  }

  dlgNext.addEventListener("click", nextLine);
  dlgClose.addEventListener("click", closeDialogue);

  // Click NPC to start their dialogue
  document.querySelectorAll(".npc").forEach(el => {
    el.addEventListener("click", async () => {
      try{
        const catalogUrl = el.getAttribute("data-catalog");
        const speaker = el.getAttribute("data-speaker") || "…";
        const portrait = el.getAttribute("data-portrait") || el.src;

        const data = await loadJSON(catalogUrl);

        // Expected format options:
        // 1) { "lines": ["...", "..."] }
        // 2) { "nodes": [ { "text":"..." }, ... ] }
        let lines = [];

        if (Array.isArray(data?.lines)) {
          lines = data.lines;
        } else if (Array.isArray(data?.nodes)) {
          lines = data.nodes.map(n => n.text).filter(Boolean);
        } else if (Array.isArray(data)) {
          lines = data;
        } else {
          lines = ["…"];
        }

        openDialogue({ speaker, portraitSrc: portrait, lines });

      } catch(err){
        console.error(err);
        openDialogue({
          speaker: el.getAttribute("data-speaker") || "…",
          portraitSrc: el.getAttribute("data-portrait") || el.src,
          lines: ["(Dialogue failed to load.)"]
        });
      }
    });
  });

});
</script>
</body>
</html>


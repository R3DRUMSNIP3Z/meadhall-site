<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mead Hall Profile</title>
  <meta name="description" content="Your Mead Hall guild profile." />
  <meta name="theme-color" content="#0b0f12" />
  <!-- Backend base -->
  <meta name="api-base" content="https://meadhall-site.onrender.com" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="icon" href="/logo/favicon.ico" sizes="any" />
  <link rel="apple-touch-icon" href="/logo/apple-touch-icon.png" />
  <meta property="og:image" content="/logo/logo-512.png" />

  <!-- Odin theme -->
  <link rel="stylesheet" href="/Styles/odin.css" />

  <style>
    .page { max-width:1100px; margin:110px auto 60px; padding:0 20px; }
    .row { display:grid; gap:20px; grid-template-columns:1fr; }
    @media (min-width:980px) { .row { grid-template-columns:360px 1fr; } }
    .panel {
      background: linear-gradient(180deg, var(--glass), rgba(255,255,255,.02));
      border: 1px solid rgba(200,169,107,.22);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
    }

    /* -------- Avatar + Frames -------- */
    .avatar { width:160px; height:160px; border-radius:50%; object-fit:cover; background:#222; }
    .pfp { position:relative; display:inline-block; width:160px; height:160px; }
    .pfp > img { width:100%; height:100%; display:block; border-radius:50%; }
    .pfp.pfp--reader::after {
      content:""; position:absolute; inset:0; pointer-events:none;
      background: url("/guildbook/reader-frame.svg") no-repeat center / 100% 100%;
    }
    .pfp.pfp--premium::after {
      content:""; position:absolute; inset:0; pointer-events:none;
      background: url("/guildbook/premium-frame.svg") no-repeat center / 100% 100%;
    }
    .pfp.pfp--annual::after {
      content:""; position:absolute; inset:0; pointer-events:none;
      background: url("/guildbook/annual-frame.svg") no-repeat center / 100% 100%;
    }

    .label { font-size:12px; letter-spacing:.08em; color:var(--ink-dim); text-transform:uppercase; margin-bottom:6px; }
    .kv { margin-bottom:12px; }
    .story { padding:14px; border-radius:12px; border:1px solid rgba(200,169,107,.2); margin:10px 0; background:rgba(255,255,255,.03); }
    .muted { color:var(--ink-dim); }

    /* Gallery */
    .gallery-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(110px, 1fr)); gap:10px; }
    .gallery-grid img {
      width:100%; aspect-ratio:1 / 1; object-fit:cover;
      border-radius:10px; border:1px solid rgba(200,169,107,.2); background:#111; cursor:zoom-in;
    }

    /* ------ LIGHTBOX ------ */
    .lightbox { position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; opacity:0; transition:opacity .18s ease; z-index:9999; }
    .lightbox.open { display:block; opacity:1; }
    .lb-stage { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:60px 80px; }
    .lb-img { max-width:min(92vw,1400px); max-height:86vh; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.6); background:#111; object-fit:contain; user-select:none; }
    .lb-close, .lb-prev, .lb-next {
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(20,20,20,.5); border:1px solid rgba(200,169,107,.35); color:#e9e4d5;
      width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center;
      font-size:22px; cursor:pointer; user-select:none; backdrop-filter: blur(4px);
    }
    .lb-prev { left:18px; } .lb-next { right:18px; }
    .lb-close { top:18px; right:18px; transform:none; width:42px; height:42px; font-size:20px; }
    .lb-meta { position:absolute; left:0; right:0; bottom:10px; text-align:center; color:#d8caa6; font-size:13px; letter-spacing:.04em; opacity:.9; padding:4px 10px; }
    .lb-counter { opacity:.8; font-variant-numeric: tabular-nums; }

    /* ===== Notifications (axes icon + badge) ===== */
    .notif-wrapper {
      position:relative; display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px; padding:0; border:0; background:transparent; cursor:pointer; border-radius:10px;
    }
    .notif-icon {
      width:100%; height:100%; object-fit:contain;
      filter: drop-shadow(0 0 4px rgba(212,169,77,.35));
      transition: transform .25s ease, filter .25s ease;
    }
    .notif-wrapper:hover .notif-icon {
      transform: rotate(-8deg) scale(1.06);
      filter: drop-shadow(0 0 10px rgba(255,215,120,.9));
    }
    .notif-badge {
      position:absolute; top:-4px; right:-6px;
      min-width:18px; height:18px; padding:0 5px;
      display:flex; align-items:center; justify-content:center;
      background:#e43; color:#fff; font-weight:800; font-size:12px; line-height:1;
      border-radius:999px; border:2px solid #000;
      box-shadow:0 0 8px rgba(0,0,0,.55);
      transform-origin:center;
    }
    .hidden { display:none !important; }
    @keyframes badge-pop {
      0% { transform:scale(0); opacity:0; }
      70% { transform:scale(1.15); opacity:1; }
      100% { transform:scale(1); }
    }
    @keyframes axe-wiggle {
      0%,100% { transform: rotate(0deg); }
      50% { transform: rotate(-6deg); }
    }
    .notif-wrapper.has-unread .notif-icon { animation: axe-wiggle 2.8s ease-in-out infinite; }
    @media (prefers-reduced-motion: reduce) {
      .notif-wrapper.has-unread .notif-icon, .notif-badge { animation: none !important; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; gap:22px; align-items:center;">
      <a href="/" class="brand" style="display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit">
        <img src="/logo/logo-64.png" alt="Mead Hall" style="width:40px;height:40px;border-radius:8px;object-fit:cover"/>
        <h1 style="margin:0">Mead Hall</h1>
      </a>
      <nav style="margin-left:auto; display:flex; align-items:center; gap:16px">
        <a class="navlink" href="/">Home</a>
        <a class="navlink" href="/#plans">Membership</a>
        <a class="navlink" href="/#contest">Skald Contest</a>
        <a class="navlink" href="/account.html">Edit profile</a>
        <!-- Notifications (axes) -->
        <button id="notifBtn" class="notif-wrapper" aria-label="Notifications">
          <img src="/guildbook/axes.png" alt="Notifications" class="notif-icon">
          <span id="notifBadge" class="notif-badge hidden">0</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="page">
    <h2 class="rune-title" style="margin:0 0 12px">Profile</h2>
    <p class="rune-sub" id="hello" style="margin-top:0"></p>

    <div class="row">
      <!-- Left: profile card -->
      <section class="panel">
        <div style="text-align:center">
          <div id="pfp" class="pfp">
            <img id="avatarImg" class="avatar" src="/logo/logo-512.png" alt="Avatar">
          </div>
        </div>

        <div class="kv" style="margin-top:18px">
          <div class="label">Name</div>
          <div id="name" style="font-size:20px;font-weight:700"></div>
        </div>

        <div class="kv">
          <div class="label">Email</div>
          <div id="email" class="muted"></div>
        </div>

        <div class="kv">
          <div class="label">Bio</div>
          <div id="bio"></div>
        </div>

        <div class="kv">
          <div class="label">Interests</div>
          <div id="interests" class="muted"></div>
        </div>

        <div class="cta-row" style="justify-content:flex-start;margin-top:14px">
          <a class="btn btn-viking" href="/account.html">Edit Profile</a>
          <a class="btn btn-viking" href="/friends.html">Friends</a>
          <button id="logout" class="btn btn-ghost">Log out</button>
        </div>
      </section>

      <!-- Right: stories + gallery -->
      <section class="panel">
        <h3 style="margin:0 0 8px">Stories</h3>
        <div id="stories" class="muted">No stories yet.</div>

        <hr style="border:none;border-top:1px solid rgba(200,169,107,.15);margin:18px 0">

        <h3 style="margin:0 0 8px">Gallery</h3>
        <div id="galleryGrid" class="gallery-grid">
          <div class="muted">Loading…</div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <span><span id="y"></span> Mead Hall</span>
      <span class="sep"></span>
      <span>Forged in Myriador</span>
    </div>
  </footer>

  <!-- ===== LIGHTBOX ROOT ===== -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <button class="lb-close" id="lbClose" aria-label="Close (Esc)">✕</button>
    <button class="lb-prev"  id="lbPrev"  aria-label="Previous (←)">‹</button>
    <div class="lb-stage">
      <img id="lbImg" class="lb-img" alt="Photo" draggable="false">
    </div>
    <button class="lb-next"  id="lbNext"  aria-label="Next (→)">›</button>
    <div class="lb-meta">
      <span id="lbCounter" class="lb-counter">1 / 1</span>
    </div>
  </div>

  <script type="module">
    // ---- Year
    const y = document.getElementById('y');
    if (y) y.textContent = String(new Date().getFullYear());

    // ---- API base
    const API_BASE = (document.querySelector('meta[name="api-base"]')?.content || '').trim();

    // ---- URL helpers
    function fullUrl(p) {
      if (!p) return p;
      if (/^https?:\/\//i.test(p)) return p;
      if (p.startsWith('/uploads/') || p.startsWith('uploads/')) {
        return API_BASE.replace(/\/+$/, '') + '/' + p.replace(/^\/+/, '');
      }
      return p; // site assets
    }
    function cacheBust(u) {
      return u ? (u.includes('?') ? `${u}&t=${Date.now()}` : `${u}?t=${Date.now()}`) : u;
    }

    // ---- Session
    const LS_KEY = 'mh_user';
    function getUser() { try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch { return null; } }
    function setUser(u) { localStorage.setItem(LS_KEY, JSON.stringify(u)); }

    // ---- DOM
    const hello = document.getElementById('hello');
    const nameEl = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const bioEl = document.getElementById('bio');
    const interestsEl = document.getElementById('interests');
    const avatarImg = document.getElementById('avatarImg');
    const pfpWrap = document.getElementById('pfp');
    const storiesEl = document.getElementById('stories');
    const galleryGrid = document.getElementById('galleryGrid');

    // ---- Lightbox DOM
    const lbRoot  = document.getElementById('lightbox');
    const lbImg   = document.getElementById('lbImg');
    const lbPrev  = document.getElementById('lbPrev');
    const lbNext  = document.getElementById('lbNext');
    const lbClose = document.getElementById('lbClose');
    const lbCount = document.getElementById('lbCounter');

    // ---- Lightbox state
    const LB = {
      urls: [],
      index: 0,
      open(i = 0) {
        if (!this.urls.length) return;
        this.index = (i + this.urls.length) % this.urls.length;
        lbImg.src = this.urls[this.index];
        if (lbCount) lbCount.textContent = (this.index + 1) + ' / ' + this.urls.length;
        lbRoot.classList.add('open');
        lbRoot.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        this.preloadNeighbors();
      },
      close() {
        lbRoot.classList.remove('open');
        lbRoot.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        lbImg.src = '';
      },
      next() { this.open(this.index + 1); },
      prev() { this.open(this.index - 1); },
      preloadNeighbors() {
        const a = new Image(); a.src = this.urls[(this.index + 1) % this.urls.length] || '';
        const b = new Image(); b.src = this.urls[(this.index - 1 + this.urls.length) % this.urls.length] || '';
      }
    };

    // ---- Lightbox wiring
    function setupLightbox() {
      if (!lbRoot) return;
      lbRoot.addEventListener('click', (e) => { if (e.target === lbRoot) LB.close(); });
      lbClose?.addEventListener('click', () => LB.close());
      lbPrev?.addEventListener('click', () => LB.prev());
      lbNext?.addEventListener('click', () => LB.next());

      let startX = null;
      lbImg?.addEventListener('pointerdown', (e) => { startX = e.clientX; lbImg.setPointerCapture(e.pointerId); });
      lbImg?.addEventListener('pointerup', (e) => {
        if (startX === null) return;
        const dx = e.clientX - startX; startX = null;
        const THRESH = 40;
        if (dx > THRESH) LB.prev();
        else if (dx < -THRESH) LB.next();
      });

      window.addEventListener('keydown', (e) => {
        if (!lbRoot.classList.contains('open')) return;
        if (e.key === 'Escape') LB.close();
        if (e.key === 'ArrowLeft') LB.prev();
        if (e.key === 'ArrowRight') LB.next();
      });
    }

    // ---- Frames
    function applyFrame(u) {
      if (!pfpWrap) return;
      const tier = u.membership || (getUser()?.membership) || '';
      pfpWrap.classList.remove('pfp--reader', 'pfp--premium', 'pfp--annual');
      if (tier === 'premium') pfpWrap.classList.add('pfp--premium');
      else if (tier === 'annual') pfpWrap.classList.add('pfp--annual');
      else if (tier === 'reader') pfpWrap.classList.add('pfp--reader');
    }

    // ---- Render user
    function renderUser(u) {
      if (hello) hello.textContent = `Welcome, ${u.name || 'skald'}.`;
      if (nameEl) nameEl.textContent = u.name || '';
      if (emailEl) emailEl.textContent = u.email || '';
      if (bioEl) bioEl.textContent = u.bio || '';
      if (interestsEl) interestsEl.textContent = u.interests || '';
      if (avatarImg) {
        const src = u.avatarUrl ? cacheBust(fullUrl(u.avatarUrl)) : '/logo/logo-512.png';
        avatarImg.src = src;
        avatarImg.onerror = () => { avatarImg.src = '/logo/logo-512.png'; };
      }
      applyFrame(u);
    }

    // ---- Stories
    async function loadStories(uid) {
      if (!storiesEl) return;
      storiesEl.textContent = 'Loading…';
      try {
        const r = await fetch(`${API_BASE}/api/users/${uid}/stories`);
        const list = r.ok ? await r.json() : [];
        if (!Array.isArray(list) || list.length === 0) {
          storiesEl.textContent = 'No stories yet.';
          storiesEl.classList.add('muted');
          return;
        }
        storiesEl.classList.remove('muted');
        storiesEl.innerHTML = '';
        for (const s of list) {
          const div = document.createElement('div');
          div.className = 'story';
          const when = s.createdAt ? new Date(s.createdAt).toLocaleString() : '';
          div.innerHTML = `
            <strong>${s.title || 'Untitled'}</strong>
            <div class="muted" style="font-size:12px">${when}</div>
            <p style="margin:.4em 0 0">${String(s.text || '').replace(/\n/g, '<br>')}</p>
          `;
          storiesEl.appendChild(div);
        }
      } catch {
        storiesEl.textContent = 'No stories yet.';
        storiesEl.classList.add('muted');
      }
    }

    // ---- Gallery
    function normalizePhotos(raw) {
      if (Array.isArray(raw)) return raw;
      if (Array.isArray(raw?.items)) return raw.items;
      return [];
    }
    function toImgUrl(p) { return /^https?:\/\//i.test(p || '') ? p : fullUrl(p); }

    async function loadGallery(uid) {
      if (!galleryGrid) return;
      galleryGrid.innerHTML = `<div class="muted">Loading…</div>`;
      try {
        const r = await fetch(`${API_BASE}/api/users/${uid}/gallery`);
        const data = r.ok ? await r.json() : [];
        const photos = normalizePhotos(data);
        if (!photos.length) {
          galleryGrid.innerHTML = `<div class="muted">No photos yet.</div>`;
          LB.urls = [];
          return;
        }
        galleryGrid.innerHTML = '';
        LB.urls = [];
        photos.forEach((p, i) => {
          const url = cacheBust(toImgUrl(p.url || p.path || ''));
          LB.urls.push(url);
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.alt = 'Gallery photo';
          img.src = url;
          img.dataset.index = String(i);
          img.onerror = () => { img.style.opacity = '0.3'; };
          img.addEventListener('click', () => LB.open(i));
          galleryGrid.appendChild(img);
        });
      } catch {
        galleryGrid.innerHTML = `<div class="muted">Failed to load photos.</div>`;
        LB.urls = [];
      }
    }

    // ---- Fetch fresh user (keeps old membership if missing)
    async function loadUserFresh(u) {
      if (!API_BASE || !u?.id) return u;
      try {
        const r = await fetch(`${API_BASE}/api/users/${u.id}`);
        if (!r.ok) throw new Error(await r.text());
        const fresh = await r.json();
        if (!fresh.membership && u.membership) fresh.membership = u.membership;
        setUser(fresh);
        return fresh;
      } catch {
        return u;
      }
    }

    // ---- Notifications (axes)
    const notifBtn   = document.getElementById('notifBtn');
    const notifBadge = document.getElementById('notifBadge');

    function setNotifications(count) {
      const n = Math.max(0, Number(count || 0));
      if (!notifBadge) return;
      if (n > 0) {
        notifBadge.textContent = n > 99 ? '99+' : String(n);
        notifBadge.classList.remove('hidden');
        notifBtn?.classList.add('has-unread');
        notifBadge.style.animation = 'badge-pop .35s ease';
        setTimeout(() => { notifBadge.style.animation = ''; }, 400);
      } else {
        notifBadge.classList.add('hidden');
        notifBtn?.classList.remove('has-unread');
      }
    }

    notifBtn?.addEventListener('click', () => {
      // Clear count or open a notifications view
      setNotifications(0);
      // e.g. navigate later: location.href = '/notifications.html';
    });

    // Sync count via localStorage if other pages update it
    window.addEventListener('storage', (e) => {
      if (e.key === 'mh_unread') {
        try { setNotifications(JSON.parse(e.newValue || '0')); } catch { setNotifications(0); }
      }
    });

    // ---- Init
    function setupLogout() {
      const btn = document.getElementById('logout');
      if (!btn) return;
      btn.addEventListener('click', () => {
        localStorage.removeItem('mh_user');
        location.href = '/';
      });
    }

    async function init() {
      setupLightbox();
      setupLogout();

      // Notifications demo default if nothing stored
      try {
        const stored = localStorage.getItem('mh_unread');
        if (stored) setNotifications(JSON.parse(stored));
        else setNotifications(3);
      } catch {
        setNotifications(3);
      }

      let u = getUser();
      if (!u?.id) {
        if (hello) hello.textContent = "You're not signed in.";
        return;
      }
      u = await loadUserFresh(u);
      renderUser(u);
      await loadStories(u.id);
      await loadGallery(u.id);
    }

    // Re-init if another tab updates user
    window.addEventListener('storage', (e) => {
      if (e.key === 'mh_user') init();
    });

    init();
  </script>
</body>
</html>












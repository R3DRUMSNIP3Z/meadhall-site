<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Valhalla Ascending — Brísingr Shop</title>

  <!-- Backend base URL -->
  <meta name="api-base" content="https://meadhall-site.onrender.com" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

  <style>
  :root { --gold:#d4a94d; --bg:#0b0e10; --card:#12161a; --muted:#c7b07a; }
  *{ box-sizing:border-box; -webkit-font-smoothing:antialiased; }
  body{ background:var(--bg); color:var(--gold); font-family:"Cinzel",serif; margin:0; min-height:100vh; }
  .wrap{ max-width:980px; margin:0 auto; padding:20px; }
  h1{ margin:10px 0 16px; font-size:1.6rem; display:flex; gap:10px; align-items:center; }
  .card{ background:var(--card); border:1px solid #3b3325; border-radius:14px; padding:14px; }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .muted{ opacity:.85 }

  a.game-btn, button.game-btn{
    display:inline-flex; gap:8px; align-items:center;
    background:#1b2228; border:1px solid #3b3325; border-radius:10px;
    color:var(--gold); padding:8px 12px; text-decoration:none; cursor:pointer;
  }
  a.game-btn:hover, button.game-btn:hover{ background:#252c32; filter:drop-shadow(0 0 4px rgba(212,169,77,.6)); }

  .balance{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid #3b3325; border-radius:10px; background:#0e1114;
  }
  .br-icon{
    width:20px; height:20px; object-fit:contain; display:block;
    filter: drop-shadow(0 0 4px rgba(100,180,255,.45));
  }
  .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
  .spacer{ flex:1 1 auto; }

  /* Shop list */
  .shop-item{
    display:flex; justify-content:space-between; align-items:center;
    gap:12px; padding:10px 0;
    border-bottom:1px dashed rgba(212,169,77,.15);
  }
  .shop-left{ display:flex; gap:10px; align-items:center; min-width:0; }
  .shop-text{ display:flex; flex-direction:column; min-width:0; }
  .shop-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .shop-sub{ font-size:.95rem; }
  .shop-right{ display:flex; align-items:center; gap:12px; }
  .price{
    display:inline-flex; align-items:center; gap:6px; min-width:70px; justify-content:flex-end;
  }

  .shop-thumb{
    position:relative; display:inline-grid; place-items:center;
    width:44px; height:44px; flex:0 0 44px; overflow:hidden; border-radius:8px;
  }
  .shop-img{ width:44px; height:44px; object-fit:contain; background:rgba(0,0,0,.35);
             box-shadow:0 0 0 1px rgba(212,169,77,.3); border-radius:8px; display:block; }
  .shop-frame{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; }

  /* Tooltip */
  #vaTooltip{
    position:fixed; display:none; z-index:9999; min-width:220px; max-width:320px;
    padding:10px; border-radius:10px; border:1px solid rgba(212,169,77,.35);
    background:#101317; color:#d4a94d; box-shadow:0 8px 30px rgba(0,0,0,.45);
    font-family:Cinzel,serif; font-size:.95rem;
  }
  .tt-title{ font-weight:900; margin-bottom:6px; }
  .muted-line{ opacity:.85 }

  /* Back button */
  #backToGame{
    position:fixed; top:14px; left:20px; z-index:10;
    background:#1b2228; border:1px solid #3b3325; border-radius:10px;
    color:var(--gold); padding:8px 12px; text-decoration:none;
    box-shadow:0 2px 6px rgba(0,0,0,.35);
  }
  #backToGame:hover{ background:#252c32; filter:drop-shadow(0 0 4px rgba(212,169,77,.6)); }
  </style>
</head>
<body>
  <a id="backToGame" href="/game.html">← Back to Arena</a>

  <!-- Tooltip -->
  <div id="vaTooltip"></div>

  <div class="wrap">
    <h1>
  <img src="/guildbook/Currency/Brisingr.png" alt="Brísingr"
       style="width:26px;height:26px;vertical-align:middle;margin-right:8px;
              filter:drop-shadow(0 0 6px rgba(130,220,255,.5));">
  Brísingr Shop
</h1>


    <div class="card">
      <div class="toolbar">
        <div class="balance">
          <img id="brIcon" class="br-icon" src="/guildbook/Currency/Br%C3%ADsingr.png" alt="Brísingr">
          <span id="brCount">0</span>
        </div>

        <span class="spacer"></span>

        <!-- Hook this to your checkout/membership later -->
        <a id="buyBrisingr" href="/account.html#brisingr" class="game-btn" title="Buy Brísingr with real money">
          Buy Brísingr
        </a>
      </div>

      <div id="shop"></div>
    </div>
  </div>

  <script type="module">
    // ---- Config & helpers ----
    const apiBase = (document.querySelector('meta[name="api-base"]')?.content || "").trim();
    const LS_KEY = "mh_user";
    function getUserId() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const obj = JSON.parse(raw);
          return obj?.id || obj?._id || obj?.user?.id || null;
        }
      } catch {}
      const qs = new URLSearchParams(location.search).get("user");
      return qs || null;
    }
    const userId = getUserId();
    if (!userId) alert("Missing user. Make sure you're logged in.");

    const $ = (id) => document.getElementById(id);
    const tooltip = $("vaTooltip");

    function resolveImg(u) {
      if (!u) return "";
      if (/^https?:\/\//i.test(u)) return u;
      if (u.startsWith("/")) return u;
      return u;
    }

    const rarityFrame = {
      normal: "/guildbook/frames/normal-frame.svg",
      epic: "/guildbook/frames/epic-frame.svg",
      legendary: "/guildbook/frames/legendary-frame.svg",
    };

    function tipShow(x, y, html) {
      tooltip.innerHTML = html;
      tooltip.style.display = "block";
      const pad = 12;
      const w = tooltip.offsetWidth || 260;
      const h = tooltip.offsetHeight || 120;
      const nx = Math.min(window.innerWidth - w - pad, x + 16);
      const ny = Math.min(window.innerHeight - h - pad, y + 16);
      tooltip.style.left = nx + "px";
      tooltip.style.top = ny + "px";
    }
    function tipMove(ev) {
      if (tooltip.style.display === "none") return;
      tipShow(ev.clientX, ev.clientY, tooltip.innerHTML);
    }
    function tipHide(){ tooltip.style.display = "none"; }
    window.addEventListener("scroll", tipHide);
    window.addEventListener("resize", tipHide);

    function tooltipHTML(item) {
      const rarity = (item.rarity || "normal");
      const stat = `+${item.boost} ${item.stat}`;
      const slot = item.slot ? String(item.slot).charAt(0).toUpperCase() + String(item.slot).slice(1) : "Unknown";
      const setTag = item.set ? ` <span class="muted-line">[${item.set}]</span>` : "";
      return `
        <div class="tt-title">${item.name}${setTag} <span class="muted-line">(${rarity})</span></div>
        <div class="muted-line">Slot: ${slot}</div>
        <div class="muted-line">Stats: ${stat}</div>
      `;
    }

    async function api(path, opts = {}) {
      const r = await fetch(apiBase + path, {
        ...opts,
        headers: {
          "Content-Type": "application/json",
          "x-user-id": userId || "",
          ...(opts.headers || {}),
        },
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // ---- State ----
    const state = { me: null, items: [] };

    function setBrisingrCount(n) { $("brCount").textContent = String(n ?? 0); }

    function renderShop() {
      const box = $("shop");
      box.innerHTML = "";

      state.items.forEach(item => {
        const rarity = (item.rarity || "normal").toLowerCase();
        const frameUrl = rarityFrame[rarity] || rarityFrame.normal;
        const cost = item.costDiamonds ?? item.costDiamond ?? item.cost; // flexible naming

        const line = document.createElement("div");
        line.className = "shop-item";
        line.innerHTML = `
          <div class="shop-left">
            <span class="shop-thumb">
              <img class="shop-img" src="${resolveImg(item.imageUrl)}" alt="${item.name}">
              <img class="shop-frame" src="${resolveImg(frameUrl)}" alt="">
            </span>
            <div class="shop-text">
              <div class="shop-title">${item.name}${item.levelReq ? ` <span class="muted">(Lv ${item.levelReq}+)</span>` : ""}</div>
              <div class="shop-sub muted">+${item.boost} ${item.stat}${item.slot ? ` • ${String(item.slot).toUpperCase()}` : ""}</div>
            </div>
          </div>
          <div class="shop-right">
            <div class="price">
              <img class="br-icon" src="/guildbook/Currency/Br%C3%ADsingr.png" alt="Brísingr" onerror="this.src='/guildbook/Currency/Brisingr.png'">
              <span>${cost ?? 0}</span>
            </div>
            <button class="game-btn buy-btn" data-id="${item.id}">Buy</button>
          </div>
        `;

        line.onmouseenter = (ev) => tipShow(ev.clientX, ev.clientY, tooltipHTML(item));
        line.onmousemove = (ev) => tipMove(ev);
        line.onmouseleave = tipHide;

        box.appendChild(line);
      });

      box.addEventListener("click", async (ev) => {
        const btn = ev.target.closest(".buy-btn");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        btn.disabled = true;
        try {
          const res = await api("/api/game/brisingr/buy", {
            method: "POST",
            body: JSON.stringify({ itemId: id }),
          });
          state.me = res.me || state.me;
          const br = (state.me && (state.me.brisingr ?? (state.me.diamonds ?? 0))) || 0;
          setBrisingrCount(br);
          // naive refresh to hide purchased item if server omits it from list next time
          await loadItems();
        } catch (e) {
          alert((e && e.message) ? e.message : "Purchase failed.");
        } finally {
          btn.disabled = false;
        }
      });
    }

    async function loadMe() {
      try {
        const r = await api("/api/game/me");
        state.me = r.me;
        const br = (state.me && (state.me.brisingr ?? (state.me.diamonds ?? 0))) || 0;
        setBrisingrCount(br);
      } catch {}
    }

    async function loadItems() {
      try {
        const r = await api("/api/game/brisingr-shop");
        state.items = r.items || [];
      } catch {
        state.items = [];
      }
      renderShop();
    }

    // Icon fallback if the accent filename isn’t present in hosting
    const icon = document.getElementById("brIcon");
    icon?.addEventListener("error", () => { icon.src = "/guildbook/Currency/Brisingr.png"; });

    // Boot
    (async function boot(){
      await loadMe();
      await loadItems();
    })();
  </script>
</body>
</html>

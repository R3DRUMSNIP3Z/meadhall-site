<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Valhalla Ascending — Brísingr Shop</title>

  <!-- Backend base URL -->
  <meta name="api-base" content="https://meadhall-site.onrender.com" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

  <style>
  :root { --gold:#d4a94d; --bg:#0b0e10; --card:#12161a; --muted:#c7b07a; }
  *{ box-sizing:border-box; -webkit-font-smoothing:antialiased; }
  body{ background:var(--bg); color:var(--gold); font-family:"Cinzel",serif; margin:0; min-height:100vh; }
  .wrap{ max-width:980px; margin:0 auto; padding:20px; }
  h1{ margin:10px 0 16px; font-size:1.6rem; display:flex; gap:10px; align-items:center; }
  .card{ background:var(--card); border:1px solid #3b3325; border-radius:14px; padding:14px; }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .muted{ opacity:.85 }

  a.game-btn, button.game-btn{
    display:inline-flex; gap:8px; align-items:center;
    background:#1b2228; border:1px solid #3b3325; border-radius:10px;
    color:var(--gold); padding:8px 12px; text-decoration:none; cursor:pointer;
  }
  a.game-btn:hover, button.game-btn:hover{ background:#252c32; filter:drop-shadow(0 0 4px rgba(212,169,77,.6)); }

  .balance{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid #3b3325; border-radius:10px; background:#0e1114;
  }
  .br-icon{
    width:20px; height:20px; object-fit:contain; display:block;
    filter: drop-shadow(0 0 4px rgba(100,180,255,.45));
  }
  .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
  .spacer{ flex:1 1 auto; }

  /* Shop list */
  .shop-item{
    display:flex; justify-content:space-between; align-items:center;
    gap:12px; padding:10px 0;
    border-bottom:1px dashed rgba(212,169,77,.15);
  }
  .shop-left{ display:flex; gap:10px; align-items:center; min-width:0; }
  .shop-text{ display:flex; flex-direction:column; min-width:0; }
  .shop-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .shop-sub{ font-size:.95rem; }
  .shop-right{ display:flex; align-items:center; gap:12px; }
  .price{
    display:inline-flex; align-items:center; gap:6px; min-width:70px; justify-content:flex-end;
  }

  .shop-thumb{
    position:relative; display:inline-grid; place-items:center;
    width:44px; height:44px; flex:0 0 44px; overflow:hidden; border-radius:8px;
  }
  .shop-img{ width:44px; height:44px; object-fit:contain; background:rgba(0,0,0,.35);
             box-shadow:0 0 0 1px rgba(212,169,77,.3); border-radius:8px; display:block; }
  .shop-frame{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; }

  /* Tooltip */
  #vaTooltip{
    position:fixed; display:none; z-index:9999; min-width:220px; max-width:320px;
    padding:10px; border-radius:10px; border:1px solid rgba(212,169,77,.35);
    background:#101317; color:#d4a94d; box-shadow:0 8px 30px rgba(0,0,0,.45);
    font-family:Cinzel,serif; font-size:.95rem;
  }
  .tt-title{ font-weight:900; margin-bottom:6px; }
  .muted-line{ opacity:.85 }

  /* Back button */
  #backToGame{
    position:fixed; top:14px; left:20px; z-index:10;
    background:#1b2228; border:1px solid #3b3325; border-radius:10px;
    color:var(--gold); padding:8px 12px; text-decoration:none;
    box-shadow:0 2px 6px rgba(0,0,0,.35);
  }
  #backToGame:hover{ background:#252c32; filter:drop-shadow(0 0 4px rgba(212,169,77,.6)); }
  </style>
</head>
<body>
  <a id="backToGame" href="/game.html">← Back to Arena</a>

  <!-- Tooltip -->
  <div id="vaTooltip"></div>

  <div class="wrap">
    <h1>
      <img src="/guildbook/Currency/Br%C3%ADsingr.png" alt="Brísingr"
           style="width:26px;height:26px;vertical-align:middle;margin-right:8px;
                  filter:drop-shadow(0 0 6px rgba(130,220,255,.5));">
      Brísingr Shop
    </h1>

    <div class="card">
      <div class="toolbar">
        <div class="balance">
          <img id="brIcon" class="br-icon" src="/guildbook/Currency/Br%C3%ADsingr.png" alt="Brísingr">
          <span id="brCount">0</span>
        </div>

        <span class="spacer"></span>

        <!-- Hook this to your checkout/membership later -->
        <a id="buyBrisingr" href="/account.html#brisingr" class="game-btn" title="Buy Brísingr with real money">
          Buy Brísingr
        </a>
      </div>

      <div id="shop"></div>
    </div>
  </div>

  <script type="module">
    // ---- Config & helpers ----
    const apiBase = (document.querySelector('meta[name="api-base"]')?.content || "").trim();
    const LS_KEY = "mh_user";
    function getUserId() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const obj = JSON.parse(raw);
          return obj?.id || obj?._id || obj?.user?.id || null;
        }
      } catch {}
      const qs = new URLSearchParams(location.search).get("user");
      return qs || null;
    }
    const userId = getUserId();
    if (!userId) alert("Missing user. Make sure you're logged in.");

    const $ = (id) => document.getElementById(id);
    const tooltip = $("vaTooltip");

    async function api(path, opts = {}) {
      const r = await fetch(apiBase + path, {
        ...opts,
        headers: {
          "Content-Type": "application/json",
          "x-user-id": userId || "",
          ...(opts.headers || {}),
        },
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // ---- State ----
    const state = { me: null, items: [] };

    // --- Recharge packages (edit bonuses/prices anytime) ---
    const PACKAGES = [
      { id:"pack100",   amount:100,   bonus:100,   price:0.99  },
      { id:"pack500",   amount:500,   bonus:300,   price:4.99  },
      { id:"pack1000",  amount:1000,  bonus:800,   price:9.99  },
      { id:"pack2000",  amount:2000,  bonus:2000,  price:19.99 },
      { id:"pack5000",  amount:5000,  bonus:6000,  price:49.99 },
      { id:"pack10000", amount:10000, bonus:15000, price:99.99 },
    ];

    // where your images live; packages go in /guildbook/Packages/
    const PACK_IMG_BASE = "/guildbook/Packages/";

    // build filename that tolerates the accent (falls back to non-accent)
    function packImg(amount){
      const withAccent = `${PACK_IMG_BASE}${amount}Br%C3%ADsingr.png`;
      const noAccent   = `${PACK_IMG_BASE}${amount}Brisingr.png`;
      return { withAccent, noAccent };
    }

    function setBrisingrCount(n) {
      $("brCount").textContent = String(n ?? 0);
    }

    function renderShop() {
      const box = $("shop");
      box.innerHTML = "";

      PACKAGES.forEach(p => {
        const total = p.amount + (p.bonus || 0);
        const { withAccent, noAccent } = packImg(p.amount);

        const line = document.createElement("div");
        line.className = "shop-item";
        line.innerHTML = `
          <div class="shop-left">
            <span class="shop-thumb">
              <img class="shop-img" src="${withAccent}" onerror="this.src='${noAccent}'" alt="${p.amount} Brísingr">
            </span>
            <div class="shop-text">
              <div class="shop-title">
                ${p.amount.toLocaleString()} Brísingr
                <span class="muted"> + ${p.bonus.toLocaleString()} Bonus</span>
              </div>
              <div class="shop-sub">
                Total: <strong>${total.toLocaleString()} Brísingr</strong>
              </div>
            </div>
          </div>
          <div class="shop-right">
            <div class="price">
              <span>$${p.price.toFixed(2)}</span>
            </div>
            <button class="game-btn buy-btn" data-sku="${p.id}">Buy</button>
          </div>
        `;

        // Optional tooltip reuse
        line.onmouseenter = (ev) => tipShow(ev.clientX, ev.clientY, `
          <div class="tt-title">${p.amount} Brísingr <span class="muted-line">(+${p.bonus} bonus)</span></div>
          <div class="muted-line">Total after purchase: ${total.toLocaleString()}</div>
          <div class="muted-line">Price: $${p.price.toFixed(2)}</div>
        `);
        line.onmousemove  = (ev) => tipMove(ev);
        line.onmouseleave = tipHide;

        box.appendChild(line);
      });
    }

    function tipShow(x, y, html) {
      tooltip.innerHTML = html;
      tooltip.style.display = "block";
      const pad = 12;
      const w = tooltip.offsetWidth || 260;
      const h = tooltip.offsetHeight || 120;
      const nx = Math.min(window.innerWidth - w - pad, x + 16);
      const ny = Math.min(window.innerHeight - h - pad, y + 16);
      tooltip.style.left = nx + "px";
      tooltip.style.top = ny + "px";
    }
    function tipMove(ev) {
      if (tooltip.style.display === "none") return;
      tipShow(ev.clientX, ev.clientY, tooltip.innerHTML);
    }
    function tipHide(){ tooltip.style.display = "none"; }
    window.addEventListener("scroll", tipHide);
    window.addEventListener("resize", tipHide);

    // === Stripe Checkout integration for Brísingr packages ===
    const shopBox = document.getElementById("shop");
    if (shopBox) {
      shopBox.addEventListener("click", async (ev) => {
        const btn = ev.target.closest(".buy-btn");
        if (!btn) return;

        // Map button SKU to Stripe tiers
        const sku = btn.getAttribute("data-sku") || "";
        const skuToTier = {
          pack100:   "100",
          pack500:   "500",
          pack1000:  "1000",
          pack2000:  "2000",
          pack5000:  "5000",
          pack10000: "10000",
        };

        const tier = skuToTier[sku];
        if (!tier) { alert("Unknown package."); return; }
        if (!userId) { alert("Missing user. Please log in first."); return; }

        try {
          btn.disabled = true;
          const r = await fetch(`${apiBase}/api/game/checkout/brisingr/${tier}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId }),
          });

          if (!r.ok) throw new Error(await r.text());
          const { url } = await r.json();
          if (!url) throw new Error("No checkout URL returned");
          location.href = url; // redirect to Stripe Checkout
        } catch (e) {
          console.error(e);
          alert("Checkout failed: " + (e?.message || e));
        } finally {
          btn.disabled = false;
        }
      }, { passive: true });
    }

    // === Player data + Shop rendering ===
    async function loadMe() {
      try {
        const r = await api("/api/game/me");
        state.me = r.me;
        const br = (state.me && (state.me.brisingr ?? (state.me.diamonds ?? 0))) || 0;
        setBrisingrCount(br);
      } catch {}
    }

    // For recharge page we don't load items from server—use fixed packages
    async function loadItems() {
      state.items = PACKAGES;
      renderShop();
    }

    // Icon fallback if the accent filename isn’t present in hosting
    const icon = document.getElementById("brIcon");
    icon?.addEventListener("error", () => {
      icon.src = "/guildbook/Currency/Brisingr.png";
    });

    // Boot
    (async function boot() {
      await loadMe();
      await loadItems();
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Valhalla Ascending ‚Äî Equipment Shop</title>

  <!-- Backend base URL (Render) -->
  <meta name="api-base" content="https://meadhall-site.onrender.com" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root { --gold:#d4a94d; --bg:#0b0e10; --card:#12161a; --muted:rgba(212,169,77,.8); }
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased}
    body{ margin:0; background:var(--bg); color:var(--gold); font-family:"Cinzel",serif; }
    .wrap{ max-width:980px; margin:0 auto; padding:20px; }
    h1{ margin:10px 0 16px; font-size:1.6rem; }

    .card{ background:var(--card); border:1px solid #3b3325; border-radius:14px; padding:14px; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .muted{ opacity:.85 }

    /* Back button */
    #backBtn{ text-decoration:none; background:#1b2228; border:1px solid #3b3325; color:var(--gold);
      padding:8px 12px; border-radius:10px; display:inline-block }
    #backBtn:hover{ background:#252c32 }

    /* Tabs */
    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin:0 0 12px; }
    .tab-btn {
      background:#12171c; border:1px solid #3b3325; color:var(--gold);
      padding:8px 12px; border-radius:10px; cursor:pointer; user-select:none;
    }
    .tab-btn[aria-selected="true"] {
      background:#1b2228; box-shadow:0 0 0 1px rgba(212,169,77,.25), 0 2px 10px rgba(0,0,0,.35);
      filter: drop-shadow(0 0 4px rgba(212,169,77,.4));
    }

    /* Br√≠singr balance (visible on Br√≠singr tab) */
    .balance {
      display:none; align-items:center; gap:8px; padding:6px 10px;
      border:1px solid #3b3325; border-radius:10px; background:#0e1114;
    }
    .balance.show { display:inline-flex; }
    .br-icon { width:20px; height:20px; object-fit:contain; display:block;
      filter: drop-shadow(0 0 4px rgba(100,180,255,.45)); }

    /* Shop list */
    .shop-item{
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; padding:10px 0; border-bottom:1px dashed rgba(212,169,77,.15);
    }
    .shop-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .shop-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .shop-sub{ opacity:.85; font-size:.95rem; }
    .shop-right{ display:flex; align-items:center; gap:10px; }
    .shop-price{ display:inline-flex; align-items:center; gap:6px; min-width:70px; justify-content:flex-end; }
    .gold-icon { width:18px; height:18px; object-fit:contain; display:block; }

    .shop-thumb{ position:relative; width:44px; height:44px; display:inline-grid; place-items:center; overflow:hidden; flex:0 0 44px; }
    .shop-img{ width:44px; height:44px; object-fit:contain; border-radius:6px; background:rgba(0,0,0,.35);
               box-shadow:0 0 0 1px rgba(212,169,77,.3); display:block; }
    .shop-thumb .shop-frame{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none;
                              filter: drop-shadow(0 0 6px rgba(212,169,77,.45)); }

    button{ background:#1b2228; border:1px solid #3b3325; border-radius:10px; color:var(--gold); padding:8px 12px; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    /* Tooltip bubble */
    #vaTooltip{
      position:fixed; display:none; z-index:9999; min-width:220px; max-width:320px;
      padding:10px; border-radius:10px; border:1px solid rgba(212,169,77,.35);
      background:#101317; color:#d4a94d; box-shadow:0 8px 30px rgba(0,0,0,.45);
      font-size:.95rem;
    }
    /* Diamond pulse ‚Äî subtle scale + glow */
.shop-thumb .shop-frame--diamond {
  animation: dfPulse 2.8s ease-in-out infinite;
}

@keyframes dfPulse {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 6px rgba(130, 220, 255, .35));
  }
  50% {
    transform: scale(1.03);
    filter: drop-shadow(0 0 10px rgba(160, 235, 255, .6));
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 6px rgba(130, 220, 255, .35));
  }
}
/* Character slot diamond frame (if you reuse it there) */
.rarity-frame.diamond {
  animation: dfPulse 2.8s ease-in-out infinite;
}

  </style>
</head>
<body>
  <div id="vaTooltip"></div>

  <div class="wrap">
    <div class="row" style="margin-bottom:10px">
      <a id="backBtn" href="/game.html">‚Üê Back to Arena</a>
      <div style="display:flex; align-items:center; gap:10px; margin-left:auto">
<div style="display:flex; align-items:center; gap:6px;">
  <img src="/guildbook/Currency/gold-coin.png" alt="Gold" class="gold-icon" 
       onerror="this.style.display='none'" style="width:22px; height:22px;">
  <strong id="gold">0</strong>
</div>
        <div id="brBalance" class="balance">
          <img id="brIcon" class="br-icon" src="/guildbook/Currency/Br%C3%ADsingr.png" alt="Br√≠singr">
          <span id="brCount">0</span>
        </div>
      </div>
    </div>

    <h1>üõ°Ô∏è Equipment Shop</h1>

    <div class="card">
      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Shop categories">
        <button class="tab-btn" data-tab="all" aria-selected="true"  role="tab">All</button>
        <button class="tab-btn" data-tab="helm" role="tab">Helm</button>
        <button class="tab-btn" data-tab="shoulders" role="tab">Shoulders</button>
        <button class="tab-btn" data-tab="chest" role="tab">Chest</button>
        <button class="tab-btn" data-tab="gloves" role="tab">Gloves</button>
        <button class="tab-btn" data-tab="boots" role="tab">Boots</button>
        <button class="tab-btn" data-tab="ring" role="tab">Ring</button>
        <button class="tab-btn" data-tab="wings" role="tab">Wings</button>
        <button class="tab-btn" data-tab="pet" role="tab">Pet</button>
        <button class="tab-btn" data-tab="sylph" role="tab">Sylph</button>
        <button class="tab-btn" data-tab="brisingr" role="tab">Br√≠singr</button>
      </div>

      <div id="shop"></div>
    </div>
  </div>

<!-- Load the unified game client (same include as game.html) -->
<script type="module">
    // ---------- config ----------
    const apiBase = (document.querySelector('meta[name="api-base"]')?.content || "").trim();

    // ---------- user id ----------
    const LS_KEY = "mh_user";
    function getUserId() {
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const obj = JSON.parse(raw);
          return obj?.id || obj?._id || obj?.user?.id || null;
        }
      } catch {}
      const qs = new URLSearchParams(location.search).get("user");
      return qs || null;
    }
    const userId = getUserId();
    if (!userId) alert("Missing user. Log in first.");

    // ---------- fetch helper ----------
    async function api(path, opts = {}) {
      const r = await fetch(apiBase + path, {
        ...opts,
        headers: { "Content-Type": "application/json", "x-user-id": userId || "", ...(opts.headers||{}) }
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // ---------- frames ----------
    const rarityFrame = {
      normal: "/guildbook/frames/normal-frame.svg",
      epic: "/guildbook/frames/epic-frame.svg",
      legendary: "/guildbook/frames/legendary-frame.svg",
    };

    // ---------- tooltip ----------
    const tip = document.getElementById("vaTooltip");
    function tipShow(x, y, html){
      tip.innerHTML = html; tip.style.display="block";
      const pad=12, w=tip.offsetWidth||260, h=tip.offsetHeight||120;
      tip.style.left = Math.min(window.innerWidth - w - pad, x + 16) + "px";
      tip.style.top  = Math.min(window.innerHeight - h - pad, y + 16) + "px";
    }
    function tipHide(){ tip.style.display="none"; }
    window.addEventListener("scroll", tipHide);
    window.addEventListener("resize", tipHide);

    function tooltipHTML(item){
      const rarity = (item.rarity || "normal");
      const stat = `+${item.boost} ${item.stat}`;
      const setTag = item.set ? ` <span style="opacity:.8">[${item.set}]</span>` : "";
      const slot = item.slot ? item.slot : "unknown";
      return `
        <div style="font-weight:900;margin-bottom:6px">${item.name}${setTag} <span style="opacity:.8">(${rarity})</span></div>
        <div style="display:flex;justify-content:space-between"><span>Slot</span><span style="opacity:.85">${String(slot).toUpperCase()}</span></div>
        <div style="display:flex;justify-content:space-between"><span>Stats</span><span style="opacity:.85">${stat}</span></div>
      `;
    }

    // ---------- gender helpers ----------
    function genderMismatch(me, item){
      if (item.set === "drengr")   return me.gender === "female";
      if (item.set === "skjaldmey") return me.gender === "male";
      return false;
    }
    function genderLabelFor(setId){
      if (setId === "drengr") return " (Male-only)";
      if (setId === "skjaldmey") return " (Female-only)";
      return "";
    }

    // ---------- state ----------
    let me = null;
    let goldItems = [];         // /api/game/shop
    let brisingrItems = [];     // /api/game/brisingr-shop (if available)
    let activeTab = "all";

    const shopBox = document.getElementById("shop");
    const goldEl  = document.getElementById("gold");
    const brWrap  = document.getElementById("brBalance");
    const brIcon  = document.getElementById("brIcon");
    const brCount = document.getElementById("brCount");

    // graceful icon fallback (accented filename)
    brIcon?.addEventListener("error", () => { brIcon.src = "/guildbook/Currency/Brisingr.png"; });

    async function load(){
      // me
      const meRes = await api("/api/game/me");
      me = meRes.me;
      goldEl.textContent = String(me.gold ?? 0);
      // diamond count (if present)
      const br = (me && (me.brisingr ?? (me.diamonds ?? 0))) || 0;
      brCount.textContent = String(br);

      // gold shop
      const shopRes = await api("/api/game/shop");
      goldItems = shopRes.items || [];

      // brisingr shop (optional)
      try {
        const r = await api("/api/game/brisingr-shop");
        brisingrItems = r.items || [];
      } catch {
        brisingrItems = [];
      }

      renderShop();
      hookTabs();
    }

    function hookTabs(){
      const tabs = Array.from(document.querySelectorAll(".tab-btn"));
      tabs.forEach(btn => {
        btn.addEventListener("click", () => {
          tabs.forEach(b => b.setAttribute("aria-selected", "false"));
          btn.setAttribute("aria-selected", "true");
          activeTab = btn.dataset.tab || "all";
          renderShop();
        });
      });
    }

    function currentItems(){
      if (activeTab === "brisingr") return brisingrItems;
      if (activeTab === "all")      return goldItems;
      // slot filter for gold items only
      return goldItems.filter(i => i.slot === activeTab);
    }

    function renderShop(){
  const items = currentItems();
  const equipped = new Set(Object.values(me?.slots || {}));
  shopBox.innerHTML = "";

  const onBr = activeTab === "brisingr";
  // show Br√≠singr balance only on Br√≠singr tab
  if (brWrap) brWrap.classList.toggle("show", onBr);

  for (const item of items) {
    // hide already-equipped items
    if (equipped.has(item.id)) continue;

    const locked = !!(item.levelReq && me.level < item.levelReq);
    const gMismatch = (item.set === "drengr" && me.gender === "female")
                   || (item.set === "skjaldmey" && me.gender === "male");
    const disabled = locked || gMismatch;
    const reason = gMismatch ? "Gender-locked" : (locked ? "Locked" : "Buy");

    const rarity = (item.rarity || "normal").toLowerCase();
    const frameUrl = rarityFrame[rarity] || rarityFrame.normal; // no diamond frame asset

    const line = document.createElement("div");
    line.className = "shop-item";
    line.innerHTML = `
      <div class="shop-left">
        <span class="shop-thumb">
          <img class="shop-img" src="${item.imageUrl || ""}" alt="${item.name}">
          <img class="shop-frame ${onBr ? "shop-frame--diamond" : ""}" src="${frameUrl}" alt="">
        </span>
        <div>
          <div class="shop-title">
            ${item.name}
            ${item.slot ? ` <span style="opacity:.8">[${String(item.slot).toUpperCase()}]</span>` : ""}
            ${item.levelReq ? ` <span style="opacity:.8">(Lv ${item.levelReq}+)</span>` : ""}
            ${item.set === "drengr" ? " (Male-only)" : (item.set === "skjaldmey" ? " (Female-only)" : "")}
          </div>
          <div class="shop-sub">+${item.boost} ${item.stat}</div>
        </div>
      </div>
      <div class="shop-right">
        <div class="shop-price">
          ${
            onBr
              ? `<img class="br-icon" src="/guildbook/Currency/Br%C3%ADsingr.png" onerror="this.src='/guildbook/Currency/Brisingr.png'"><span>${item.costDiamonds ?? item.costDiamond ?? item.cost ?? 0}</span>`
              : `<img class="gold-icon" src="/guildbook/Currency/gold-coin.png" alt="g" onerror="this.style.display='none'"><span>${item.cost}g</span>`
          }
        </div>
        <button data-id="${item.id}" ${disabled ? "disabled" : ""}>${reason}</button>
      </div>
    `;

    line.addEventListener("mouseenter", (ev)=> tipShow(ev.clientX, ev.clientY, tooltipHTML(item)));
    line.addEventListener("mousemove",  (ev)=> tipShow(ev.clientX, ev.clientY, tooltipHTML(item)));
    line.addEventListener("mouseleave", tipHide);

    shopBox.appendChild(line);
  }
}

  </script>

    <script type="module" src="/src/game.ts"></script>
  </body>
</html>


